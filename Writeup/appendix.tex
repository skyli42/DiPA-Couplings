

\section{Appendix A: Single Variable Programs}

\subsection{Couplings for Transitions and Straight Line Programs}

\begin{lemma}[Detailed version of lemma \ref{simplifiedIndTransitionCoupling}]\label{indTransitionCoupling}
    Let $X\brangle{1}\sim \Lap(\mu\brangle{1}, \frac{1}{d_x\varepsilon}), X\brangle{2}\sim\Lap(\mu\brangle{2}, \frac{1}{d_x\varepsilon})$ be random variables representing possible initial values of $\texttt{x}$ and let $t = (c, \sigma, \tau)$ be a transition from some valid transition alphabet $\Sigma_T$.
    Let $P(t) = (d_t, d_t')$.

    Let $\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}$ be an arbitrary valid adjacent input pair and let $o\brangle{1}$, $o\brangle{2}$ be random variables representing possible outputs of $t$ given inputs $\texttt{in}\brangle{1}$ and $\texttt{in}\brangle{2}$, respectively. 

    Then $\forall \varepsilon>0$ and for all $\gamma_x, \gamma_t, \gamma_t'\in [-1, 1]$ that satisfy the constraints \[
        \begin{cases}
          \gamma_t\leq\gamma_x & c = \lguard[\texttt{x}]\\
          \gamma_t\geq\gamma_x & c = \gguard[\texttt{x}]\\
          \gamma_t=0 & \sigma = \texttt{insample}\\
          \gamma_t'=0 & \sigma = \texttt{insample}'
        \end{cases},
      \]
      the lifting $o\brangle{1}\{(a, b): a=\sigma\implies b=\sigma\}^{\#d\varepsilon}o\brangle{2}$ is valid for $d = (|\mu\brangle{1}-\mu\brangle{2}+\gamma_x|)d_x+(|-\texttt{in}\brangle{1}+\texttt{in}\brangle{2}-\gamma_t|)d_t+(|-\texttt{in}\brangle{1}+\texttt{in}\brangle{2}-\gamma_t'|)d_t'$.
\end{lemma}

\begin{proof}
Fix $\varepsilon>0$.

We can first create the lifting $X\brangle{1}+\gamma_x (=)^{\#(|\mu\brangle{1}-\mu\brangle{2}+\gamma_x|)d_x\varepsilon}X\brangle{2}$. 

Additionally, create the lifting $z\brangle{1} (=)^{\#(|-\texttt{in}\brangle{1}+\texttt{in}\brangle{2}-\gamma_t|)d_t\varepsilon}z\brangle{2} - \texttt{in}\brangle{1}+\texttt{in}\brangle{2}-\gamma_t$, which is equivalent to creating the lifting $\texttt{insample}\brangle{1} +\gamma_t{(=)}^{\#(|-\texttt{in}\brangle{1}+\texttt{in}\brangle{2}-\gamma_t|)d_t\varepsilon}\texttt{insample}\brangle{2}$.

Finally, create the lifting $z'\brangle{1} (=)^{\#(|-\texttt{in}\brangle{1}+\texttt{in}\brangle{2}-\gamma_t'|)d_t'\varepsilon}z'\brangle{2} - \texttt{in}\brangle{1}+\texttt{in}\brangle{2}-\gamma_t'$. As before, this is equivalent to creating the lifting $\texttt{insample}'\brangle{1} +\gamma_t'{(=)}^{\#(|-\texttt{in}\brangle{1}+\texttt{in}\brangle{2}-\gamma_t'|)d_t'\varepsilon}\texttt{insample}'\brangle{2}$.

Thus, we emerge with three key statements to leverage:\begin{itemize}
    \item $X\brangle{1} + \gamma_x = X\brangle{2}$
    \item $z\brangle{1} = z\brangle{2} - \texttt{in}\brangle{1}+\texttt{in}\brangle{2}-\gamma_t$
    \item $z'\brangle{1} = z'\brangle{2} - \texttt{in}\brangle{1}+\texttt{in}\brangle{2}-\gamma_t'$
\end{itemize}

So if $c=\lguard[\texttt{x}]$ and $\gamma_t\leq \gamma_x$, then \begin{align*}
    \texttt{insample}\brangle{1}<X\brangle{1}&\implies \texttt{in}\brangle{1}+z\brangle{1}<X\brangle{1}\\
    &\implies \texttt{in}\brangle{1}+z\brangle{2}-\texttt{in}\brangle{1}+\texttt{in}\brangle{2}-\gamma_t<X\brangle{2}-\gamma_x\\
    &\implies \texttt{insample}\brangle{2}<X\brangle{2}
\end{align*}

Similarly, if $c=\gguard[\texttt{x}]$ and $\gamma_t\geq \gamma_x$, then \begin{align*}
    \texttt{insample}\brangle{1}\geq X\brangle{1}&\implies \texttt{in}\brangle{1}+z\brangle{1}\geq X\brangle{1}\\
    &\implies \texttt{in}\brangle{1}+z\brangle{2}-\texttt{in}\brangle{1}+\texttt{in}\brangle{2}-\gamma_t\geq X\brangle{2}-\gamma_x\\
    &\implies \texttt{insample}\brangle{2}\geq X\brangle{2}
\end{align*}

With these liftings, we have ensured that if the first run satisfies the guard of $t$, then the second run does as well. 

As noted, if $\sigma \in \Gamma$ and the first run taking transition $t$ implies that the second run does as well, then $o\brangle{1} = \sigma \implies o\brangle{2}=\sigma$ trivially.

Now, if $\sigma=\texttt{insample}$ and $\gamma_t=0$, then clearly we have that $\texttt{insample}\brangle{1}=\texttt{insample}\brangle{2}$, so for all $a\in \RR$, $o\brangle{1} = a\implies o\brangle{2} = a$.

Similarly, if $\sigma=\texttt{insample}'$ and $\gamma_t'=0$, we have that for all $a\in \RR$, $o\brangle{1} = a\implies o\brangle{2} = a$.

Thus, given the constraints \[
  \begin{cases}
    \gamma_t\leq\gamma_x & c = \lguard[\texttt{x}]\\
    \gamma_t\geq\gamma_x & c = \gguard[\texttt{x}]\\
    \gamma_t=0 & \sigma = \texttt{insample}\\
    \gamma_t'=0 & \sigma = \texttt{insample}'
  \end{cases},
\]
we have shown that the lifting $o\brangle{1}\{(a, b): a=\sigma\implies b=\sigma\}^{\#d\varepsilon}o\brangle{2}$ is valid, where the cost $d = (|\mu\brangle{1}-\mu\brangle{2}+\gamma_x|)d_x+(|-\texttt{in}\brangle{1}+\texttt{in}\brangle{2}-\gamma_t|)d_t+(|-\texttt{in}\brangle{1}+\texttt{in}\brangle{2}-\gamma_t'|)d_t'$. 

\end{proof}


\begin{lemma}[Detailed version of lemma \ref{simplifiedMultTransitionsCouplingProof}]\label{multTransitionsCouplingProof}
    Let $\rho = t_0\ldots t_{n-1}$ be a initialized SLP of length $n$. 
    Let $\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}$ be arbitrary adjacent input sequences of length $n$. Additionally, fix some potential output $\sigma$ of $\rho$ of length $n$ and let $\sigma\brangle{1}$, $\sigma\brangle{2}$ be random variables representing possible outputs of $\rho$ given inputs $\texttt{in}\brangle{1}$ and $\texttt{in}\brangle{2}$, respectively. Additionally, for all $t_i$, let $P(t_i) = (d_i, d_i')$.

    Then $\forall \varepsilon>0$ and for all $\{\gamma_i, \gamma_i'\}_{i=0}^{n-1}$ that, for all $i$, satisfy the constraints \[
        \begin{cases}
          \gamma_i\leq\gamma_{at(i)} & c_i = \lguard[\texttt{x}]\\
          \gamma_i\geq\gamma_{at(i)} & c_i = \gguard[\texttt{x}]\\
          \gamma_i=0 & \sigma_i = \texttt{insample}\\
          \gamma_i'=0 & \sigma_i = \texttt{insample}'
        \end{cases},
      \]
      the lifting $\sigma\brangle{1}\{(a, b): a=\sigma\implies b=\sigma\}^{\#d\varepsilon}\sigma\brangle{2}$ is valid for $d = \sum_{i=0}^{n-1}(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i|)d_i+(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i'|)d_i'$, and therefore $t$ is $d\varepsilon$-differentially private. 
\end{lemma}
\begin{proof}
    From the proof of lemma \ref{indTransitionCoupling}, we know that we can create the couplings $\texttt{insample}_i\brangle{1} +\gamma_i{(=)}^{\#(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i|)d_i\varepsilon}\texttt{insample}_i\brangle{2}$ and $\texttt{insample}_i'\brangle{1} +\gamma_i'{(=)}^{\#(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i'|)d_i'\varepsilon}\texttt{insample}_i'\brangle{2}$ for all $q_i$ in $\rho$. 

    Additionally, for some fixed $q_i$ in $\rho$, if we have the coupling $\texttt{x}_i\brangle{1}+\gamma_x (=)^{\#(|\hat{\mu_i}\brangle{1}-\hat{\mu_i}\brangle{2}+\gamma_x|)\hat{d_i}\varepsilon}x_i\brangle{2}$, where $\texttt{x}_i\brangle{1}\sim \Lap(\hat{\mu_i}\brangle{1}, \frac{1}{\hat{d_i}\varepsilon})$ and $\texttt{x}_i\brangle{2}\sim \Lap(\hat{\mu_i}\brangle{2}, \frac{1}{\hat{d_i}\varepsilon})$, then subject to the constraints \[
        \begin{cases}
          \gamma_i\leq\gamma_x & c_i = \lguard[\texttt{x}]\\
          \gamma_i\geq\gamma_x & c_i = \gguard[\texttt{x}]\\
          \gamma_i=0 & \sigma_i = \texttt{insample}_i\\
          \gamma_i'=0 & \sigma_i = \texttt{insample}_i'
        \end{cases},
      \]
    the coupling $\sigma_i\brangle{1}\{(a, b): a=\sigma_i\implies b=\sigma_i\}^{\#d\varepsilon}\sigma_i\brangle{2}$ is valid for some $d$. 

    Indeed, note that for all $i$, $\texttt{x}_i = \texttt{insample}_{at(i)}$ by the semantics of an SLP. Thus, we have that $\texttt{x}_i\brangle{1}+\gamma_x (=)^{\#(|-\texttt{in}_{at(i)}\brangle{1}+\texttt{in}_{at(i)}\brangle{2}+\gamma_{at(i)}|)d_{at(i)}\varepsilon}x_i\brangle{2}$, and we must satisfy the constraints \[
        \begin{cases}
          \gamma_i\leq\gamma_{at(i)} & c_i = \lguard[\texttt{x}]\\
          \gamma_i\geq\gamma_{at(i)} & c_i = \gguard[\texttt{x}]\\
          \gamma_i=0 & \sigma_i = \texttt{insample}_i\\
          \gamma_i'=0 & \sigma_i = \texttt{insample}_i'
        \end{cases}
      \]
      for all $i$.

    Thus, we can put all of these couplings together to show that the coupling $\sigma_i\brangle{1}\{(a, b): a=\sigma_i\implies b=\sigma_i\}^{\#d\varepsilon}\sigma_i\brangle{2}$ is valid for some $d>0$.

    In particular, note that we have created at most one pair of couplings (for $\texttt{insample}$ and $\texttt{insample}'$) for each $q_i$. Thus, the total coupling cost associated with each $q_i$ is at most $(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i|)d_i+(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i'|)d_i'$, 
    which gives us an overall coupling cost of $d = \sum_{i=0}^{n-1}(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i|)d_i+(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i'|)d_i'$.
\end{proof}

\subsection{DiPA and Programs}

We copy the definitions of leaking cycles, leaking pairs, disclosing cycles, and privacy violating paths from \cite{chadhaLinearTimeDecidability2021} for clarity. 

\begin{defn}[Leaking Cycles~\cite{chadhaLinearTimeDecidability2021}]
    A path $\rho = q_0\to\ldots \to q_n$ in a DiPA $A$ is a leaking path if there exist indices $i, j$ where $0\leq i < j < n$ such that the $i$'th transition $q_i\to q_{i+1}$ in $\rho$ is an assignment transition and the guard of the transition $q_j \to q_{j+1}$ is not $\texttt{true}$. If $\rho$ is also a cycle, then we call it a leaking cycle.
\end{defn}

\begin{defn}[\cite{chadhaLinearTimeDecidability2021}]
    A cycle $\rho$ in a DiPA $A$ is an \lcycle~if for some transition $q_i\to q_{i+1}$ in $\rho$, $\guard(q_i\to q_{i+1}) = \lguard[\texttt{x}]$. Similarly, $\rho$ is a \gcycle~if for some transition $q_i\to q_{i+1}$ in $\rho$, $\guard(q_i\to q_{i+1}) = \gguard[\texttt{x}]$.
    
    Additionally, a path $\rho$ of a DiPA $A$ is an \texttt{AL}-path (respectively, \texttt{AG}-path) if all assignment transitions in $\rho$ have guard $\lguard[\texttt{x}]$ (respectively, $\gguard[\texttt{x}]$)
\end{defn}

\begin{defn}[Leaking Pairs \cite{chadhaLinearTimeDecidability2021}]
    A pair of cycles $(C, C')$ is called a leaking pair if one of the following two conditions is satisfied.
    \begin{enumerate}
        \item $C$ is an \lcycle, $C'$ is a \gcycle~and there is an \texttt{AG}-path from a location in $C$ to a location in $C'$.
        \item $C$ is a \gcycle, $C'$ is an \lcycle~and there is an \texttt{AL}-path from a location in $C$ to a location in $C'$.
    \end{enumerate}
\end{defn}

\begin{defn}[Disclosing Cycles \cite{chadhaLinearTimeDecidability2021}]
    A cycle $C = q_0\to \ldots \to q_n \to q_0$ of a DiPA $A$ is a disclosing cycle if there is an $i$, $0 \leq i < |C|$ such that $q_i\in Q_{in}$ and the transition $q_i\to q_{i+1}$ that outputs either \texttt{insample} or \texttt{insample}'.
\end{defn}

\begin{defn}[Privacy Violating Paths \cite{chadhaLinearTimeDecidability2021}]
    We say that a path $\rho = q_0\to\ldots \to q_n $ of a DiPA $A$ is a privacy violating path if one of the following conditions hold:
    \begin{itemize}
        \item  $tail(\rho)$ is an \texttt{AG}-path (resp., \texttt{AL}-path) such that $last(\rho)$ is in a \gcycle~(resp., \lcycle) and the 0th transition $q_0\to q_1$ is an assignment transition that outputs \texttt{insample}.
        \item $\rho$ is an \texttt{AG}-path (resp., \texttt{AL}-path) such that $q_n$ is in a \gcycle~(resp., \lcycle) and the first transition $q_0\to q_1$ has guard $\lguard[\texttt{x}]$ (resp., $\gguard[\texttt{x}]$) and outputs \texttt{insample}
        \item $\rho$ is an \texttt{AG}-path (resp., \texttt{AL}-path) such that $q_0$ is in an \lcycle~(resp., \gcycle) and the last transition $q_{n-1}\to q_n$ has guard $\gguard[\texttt{x}]$ (resp., $\lguard[\texttt{x}]$) and outputs \texttt{insample}
    \end{itemize}
\end{defn}


\begin{lemma}\label{unsatisfiableImpliesNotWellformedLemma}
    If a periodic program $L$ generated by $G_L$ satisfies output distinction and there does not exist a coupling strategy $C$ that satisfies the privacy constraint system for $L$, then $G_L$ must contain either a leaking cycle, a leaking pair, a disclosing cycle, or a privacy violating path. 
\end{lemma}

\begin{proof}[Proof of lemma \ref{unsatisfiableImpliesNotWellformedLemma}]
    Let $L$ be a periodic program in $P$ that does not have a coupling strategy that satisfies the privacy constraint system.

    Consider a ``maximally'' satisfied coupling strategy $C=(\mathbf{\gamma}, \mathbf{\gamma}')$ for $L$; i.e. there is no other coupling strategy $C'$ for $L$ such that $C'$ satisfies more constraints than $C$. By lemma \ref{integersAreEnoughForATLemma}, we are allowed to only consider coupling strategies $C=(\gamma, \gamma')$ such that, for all $i\in AT(A)$, $\gamma_i \in \{-1, 0, 1\}$. 

    Fix some SLP $\rho$ in $A$ such that at least one constraint is not satisfied by $C$ as applied to $\rho$.

    By assumption, at least one constraint is unsatisfied by $C$. We will show that in every case, $A$ must contain at least one of a leaking cycle, leaking pair, disclosing cycle, or privacy violating path. By theorem \ref{DiPACounterexamplesThm}, this is sufficient to show that $A$ is not $d\varepsilon$-differentially private for any $d>0$.

    \textbf{Case 1: (1) is unsatisfied for $\gamma_i$}
    
    In this case, $c_i = \lguard[\texttt{x}]$ and $\gamma_i > \gamma_{at(i)}$. Note that $\gamma_{at(i)} \neq 1$. 

    We can assume that for all assignment transitions $t_{at(k)}$ in $\rho$ that $t_{at(k)}$ is not in a cycle, since otherwise there would be a leaking cycle in $A$. 

    \textbf{Case 1.1: $t_i$ is in a cycle}

    In this case, we can suppose that $t_i$ is not an assignment transition and $t_i$ does not output $\texttt{insample}$ or $\texttt{insample}'$, since otherwise either a leaking cycle or a disclosing cycle would clearly exist in $A$. We can thus additionally assume that constraint (5) is satisfied for $\gamma_i$. 
    
    Noe that the cycle containing $t_i$ is also an $\texttt{L}$-cycle by definition.

    Then attempting to resolve (1) for $\gamma_i$ by setting $\gamma_{at(i)} = 1$ must violate another constraint. In particular, either constraint (1) or (3) for $\gamma_{at(i)}$ or constraint (2) for some $\gamma_j$ such that $at(j) = at(i)$ must be newly violated. Note that constraint (5) for $\gamma_{at(i)}$ cannot be violated since we assumed that $t_{at(i)}$ is not in a cycle. 

    \textbf{Case 1.1.1: setting $\gamma_{at(i)} = 1$ violates constraint (1) for $\gamma_{at(i)}$}

    Let $t_{at(k)}$ be the earliest assignment transition before $t_{at(i)}$ such that, for all $at(k)\leq at(l)< at(i)$, $\gamma_{at(l)} <1$ and $c_{at(l)} = \lguard[\texttt{x}]$. Then there must be \textit{some} $\gamma_{at(l)}$ such that setting $\gamma_{at(l)} = 1$ would violate constraint (2) for some $\gamma_{l'}$ such that $at(l') = at(l)$. 

    Observe that $c_{l'} = \gguard[\texttt{x}]$ and there is an $\texttt{AL}$-path from $t_{l'}$ to $t_i$. 

    Then setting $\gamma_{l'}= 1$ must violate either constraint (3) or constraint (5) for $\gamma_{l'}$. If constraint (3) is violated, then $\gamma_{l'}$ is a transition with guard $\gguard[\texttt{x}]$ that outputs $\texttt{insample}$, so there is a privacy violating path from $t_{l'}$ to $t_i$. Otherwise if constraint (5) is violated, then $\gamma_{l'}$ is in a \gcycle, so there is a leaking pair composed of the cycles containing $t_{l'}$ and $t_i$, repectively. 

    \textbf{Case 1.1.2: Setting $\gamma_{at(i)}=1$ would violate (3) for $\gamma_{at(i)}$}

    Then $\gamma_{at(i)}$ is an assignment transition that outputs $\texttt{insample}$. Further, the path from $t_{at(i)}$ to $t_i$ is an $\texttt{AL}$-path, since there are no transitions on it. Thus, there is a privacy violating path from $t_i{at(i)}$ to $t_i$

    \textbf{Case 1.1.3: Setting $\gamma_{at(i)}=1$ would violate (2) for some $\gamma_j$ such that $at(j)= at(i)$}

    Note that, if $i<j$, the path from $t_i$ to $t_j$ (or vice versa, if $j<i$) is both an $\texttt{AL}$ and $\texttt{AG}$-path.

    Setting $\gamma_{j}= 1$ must violate either constraint (3) or constraint (5) for $\gamma_{j}$. 
    
    If constraint (3) is violated, then $\gamma_{j}$ is a transition with guard $\gguard[\texttt{x}]$ that outputs $\texttt{insample}$. Thus if $i<j$, there is a privacy violating path from $t_i$ to $t_j$ and if $j<i$, there is a privacy violating path from $t_j$ to $t_i$. 
    
    Otherwise if constraint (5) is violated, then $\gamma_{j}$ is in a \gcycle, so there is a leaking pair composed of the cycle containing $t_j$ and the cycle containing $t_i$ if $j<i$ or vice versa if $j>i$. 

    \textbf{Case 1.2: $t_i$ is not in a cycle}

    Note that $t_i$ must either be an assignment transition or output $\texttt{insample}$ or both, since otherwise, setting $\gamma_i = \gamma_{at(i)}$ would resolve constraint (1) for $\gamma_i$ without violating any other constraint. 

    \textbf{Case 1.2.1: $t_i$ outputs $\texttt{insample}$ and $t_i$ is an assignment transition}

    In this case, attempting to resolve constraint (1) without violating constraint (3) for $\gamma_i$ by setting $\gamma_i = \gamma_{at(i)} = 0$ must violate some other constraint. In particular, setting $\gamma_{at(i)} = 0$ can newly violate constraint (1) for $\gamma_{at(i)}$ or constraint (2) for some $\gamma_j$ such that $at(j) = at(i)$; note that setting $\gamma_{at(i)}=0$ cannot \textit{newly} violate constraint (1) for some $\gamma_j$ such that $at(j) = at(i)$. 
    Alternatively, setting $\gamma_i = 0$ could potentially newly violate either constraint (1) or constraint (2) for some $\gamma_j$ such that $at(j) = i$. 

    \textbf{Case 1.2.2.1: Setting $\gamma_{at(i)} =0$ violates constraint (1) for $\gamma_{at(i)}$}

    Let $t_{at(k)}$ be the earliest assignment transition before $t_{at(i)}$ such that, for all $at(k)\leq at(l)< at(i)$, $\gamma_{at(l)} = -1$ and $c_{at(l)} = \lguard[\texttt{x}]$. Then there must be \textit{some} $\gamma_{at(l)}$ such that setting $\gamma_{at(l)} = 0$ would violate constraint (2) for some $\gamma_{l'}$ such that $at(l') = at(l)$.  
    Additionally, note that setting $\gamma_{l'} = \gamma_{at(l)} = 0$ can only violate constraint (5) for $\gamma_{l'}$, since $\gamma_{l'}$ cannot be an assignment transition. 
    
    Thus, $t_{l'}$ is in a cycle, so the cycle containing $t_{l'}$ is a \gcycle. Note that the path from $t_{l'}$ to $t_i$ is an $\texttt{AL}$-path. Therefore, there is a privacy violating path from $t_{l'}$ to $t_i$.

    \textbf{Case 1.2.2.2: Setting $\gamma_{at(i)} =0$ violates constraint (2) for some $\gamma_j$ such that $at(j) = at(i)$}

    Note that $j\neq i$, meaning that $t_j$ is not an assignment transition. Then setting $\gamma_j = \gamma_{at(i)} = 0$ must violate constraint (5) for $\gamma_j$; this means that $t_j$ is in a \gcycle. 

    If $i<j$, then the path from $t_i$ to $t_j$ is an $\texttt{AL}$-path, so it is also a privacy violating path.

    Otherwise if $j<i$, then the path from $t_j$ to $t_i$ is an $\texttt{AG}$ path, so it is also a privacy violating path.

    \textbf{Case 1.2.2.3: Setting $\gamma_i =0$ violates constraint (1) for some $\gamma_j$ such that $at(j) = i$}

    If $\gamma_j$ is not an assignment transition, then setting $\gamma_j = \gamma_i = 0$ must violate constraint (5) for $\gamma_j$, so $t_j$ is in an \lcycle. Then there is a privacy violating path from $t_i$ to $t_j$, since the path from $t_{i+1}$ to $t_j$ is an $\texttt{AL}$-path by virtue of not containing any assignment transitions. 

    Otherwise if $t_j$ is an assignment transition, then $\gamma_j$ must originally be set to 1. Let $t_{at(k)}$ be the latest assignment after $t_{i}$ such that, for all $i\leq at(l)< at(k)$, $\gamma_{at(l)} = 1$ and $c_{at(l)} = \lguard[\texttt{x}]$. Then there must be \textit{some} $\gamma_{at(l)}$ such that setting $\gamma_{at(l)} = 0$ would violate constraint (1) for some $\gamma_{l'}$ such that $at(l') = at(l)$.  
    Additionally, note that setting $\gamma_{l'} = \gamma_{at(l)} = 0$ can only violate constraint (5) for $\gamma_{l'}$, since $\gamma_{l'}$ cannot be an assignment transition. 

    Then $\gamma_{l'}$ must be in an \lcycle. Since the path from $t_i$ to $t_{l'}$ is an $\texttt{AL}$-path, there is a privacy violating path from $t_i$ to $t_{l'}$.

    \textbf{Case 1.2.2.4: Setting $\gamma_i =0$ violates constraint (2) for some $\gamma_j$ such that $at(j) = i$}

    This case is exactly symmetric to case 1.2.2.3.

    \textbf{Case 1.2.2: $t_i$ outputs $\texttt{insample}$ and $t_i$ is not an assignment transition}

    We can assume that $\gamma_{at(i)} = -1$ originally, since otherwise, setting $\gamma_i = 0$ would resolve constraint (1) without violating any additional ones.

    Thus attempting to resolve constraint (1) while preserving constraint (3) for $\gamma_i$ by setting $\gamma_{at(i)}=\gamma_i =0$ must violate constraint (1) for $\gamma_{at(i)}$. 
   
    Let $t_{at(k)}$ be the earliest assignment transition before $t_{at(i)}$ such that, for all $at(k)\leq at(l)< at(i)$, $\gamma_{at(l)} = -1$ and $c_{at(l)} = \lguard[\texttt{x}]$. Then there must be some $\gamma_{at(l)}$ such that setting $\gamma_{at(l)} = 0$ would violate constraint (2) for some $\gamma_{l'}$ such that $at(l') = at(l)$.  
    Additionally, note that setting $\gamma_{l'} = \gamma_{at(l)} = 0$ can only violate constraint (5) for $\gamma_{l'}$, since $\gamma_{l'}$ cannot be an assignment transition. 
    
    Thus, $t_{l'}$ is in a cycle, so the cycle containing $t_{l'}$ is a \gcycle. Note that the path from $t_{l'}$ to $t_i$ is an $\texttt{AL}$-path. Therefore, there is a privacy violating path from $t_{l'}$ to $t_i$.

    \textbf{Case 1.2.3: $t_i$ does not output $\texttt{insample}$ and $t_i$ is an assignment transition}

    In this case, attempting to resolve (1) by setting $\gamma_{at(i)} = 1$ must violate either constraint (1) or (3) for $\gamma_{at(i)}$, or constraint (2) for some $\gamma_j$ such that $at(j) = at(i)$. 

    Additionally, note that $\gamma_{at(i)} \in \{0, -1\}$. 

    \textbf{Case 1.2.3.1: $\gamma_{at(i)} =0$}

    Since originally, $\gamma_i > \gamma_{at(i)} \implies \gamma_i = 1$, we know that setting $\gamma_i = \gamma_{at(i)} = 0$ must violate constraint (1) for some $\gamma_j$ such that $at(j) = i$. If $t_{j}$ is not an assignment transition, then setting $\gamma_{j} = 0$ can only violate constraint (5) for $\gamma_{j}$, meaning that $t_j$ is in an \lcycle.

    Otherwise, if $t_j$ is an assignment transition, let $t_{at(k)}$ be the latest assignment transition after $t_{i}$ such that for all $j\leq at(l)< at(k)$, $\gamma_{at(l)} =1$ and $c_{at(k)} = \lguard[\texttt{x}]$. Then there must exist some $at(l), j\leq at(l)< at(k)$ such that setting $\gamma_{at(l)}=0$ would violate constraint (1) for some non-assignment $\gamma_{l'}$ where $at(l') = at(l)$. 

    Further, setting $\gamma_{l'} = 0$ must then violate constraint (5) for $\gamma_{l'}$, so $t_{l'}$ is in an \lcycle. 

    Therefore, there exists a $\texttt{AL}$-path from $t_i$ to some transition $t$ in an \lcycle. 

    \textbf{Case 1.2.3.1.1: Setting $\gamma_{at(i)} = 1$ would violate constraint (1) for $\gamma_{at(i)}$}

    Let $t_{at(j)}$ be the earliest assignment transition before $t_{at(i)}$ such that for all $at(j)\leq at(k)< at(i)$, $\gamma_{at(k)} =0$ and $c_{at(k)} = \lguard[\texttt{x}]$. Then there must exist some $at(k), at(j)\leq at(k)< at(i)$ such that setting $\gamma_{at(k)}=1$ would violate constraint (2) for some non-assignment $\gamma_l$ where $at(l) = at(k)$, so $c_l = \gguard[\texttt{x}]$

    Note that there is an $\texttt{AL}$-path from $t_l$ to $t_i$, and therefore an $\texttt{AL}$-path from $t_l$ to some transition $t_{o}$ in an \lcycle. 

    Further, setting $\gamma_l = \gamma_{at(k)} = 1$ must then violate either constraint (3) or (5) for $\gamma_l$. 

    If constraint (3) is violated, then $t_l$ outputs $\texttt{insample}$, so there is a privacy violating from $t_l$ to $t_o$.

    If constraint (5) is violated, then $t_l$ is in a \gcycle, so there is a leaking pair consisting of the cycle containing $t_l$ and the cycle containing $t_o$. 

    \textbf{Case 1.2.3.1.2: Setting $\gamma_{at(i)}=1$ would violate constraint (3) for $\gamma_{at(i)}$}

    Note that there is an $\texttt{AL}$ path from $t_{at(i)}$ to some transition $t_j$ such that $t_j$ is in an \lcycle.

    Then $t_{at(i)}$ is an assignment transition that outputs $\texttt{insample}$, so there is a privacy violating path from $t_{at(i)}$ to $t_j$. 
    
    \textbf{Case 1.2.3.1.3: Setting $\gamma_{at(i)}=1$ would violate constraint (2) for some $\gamma_j$ such that $at(j) = at(i)$}

    As before, note that there is an $\texttt{AL}$ path from $t_{j}$ to some transition $t_k$ such that $t_k$ is in an \lcycle.

    Then trying to set $\gamma_j = \gamma_{at(i)} = 1$ must violate either constraint (3) or constraint (5) for $\gamma_j$. If constraint (3) is violated, then $t_j$ outputs $\texttt{insample}$, so there is a privacy violating from $t_j$ to $t_k$. If constraint (5) is violated, then $t_j$ is in a \gcycle, so there is a leaking pair consisting of the cycle containing $t_j$ and the cycle containing $t_k$.  

    \textbf{Case 1.2.3.2: $\gamma_{at(i)} = -1$}

    Note that $\gamma_i \in \{0, 1\}$.

    First, if $\gamma_i = 0$, then setting $\gamma_i = -1$ must newly violate constraint (1) for some $\gamma_j$ where $at(j) = i$. If $t_{j}$ is not an assignment transition, then setting $\gamma_{j} = -1$ can only newly violate constraint (3) for $\gamma_{j}$, meaning that $t_j$ outputs $\texttt{insample}$.

    Otherwise, if $t_j$ is an assignment transition, let $t_{at(k)}$ be the latest assignment transition after $t_{i}$ such that for all $j\leq at(l)< at(k)$, $\gamma_{at(l)} =0$ and $c_{at(k)} = \lguard[\texttt{x}]$. Then there must exist some $at(l), j\leq at(l)< at(k)$ such that setting $\gamma_{at(l)}=-1$ would newly violate constraint (1) for some non-assignment $\gamma_{l'}$ where $at(l') = at(l)$; as before, this means that $t_{l'}$ outputs $\texttt{insample}$.  

    Otherwise, if $\gamma_i = 1$, then setting $\gamma_i = -1$ must newly violate constraint (1) for some $\gamma_j$ where $at(j) = i$. If $t_{j}$ is not an assignment transition, then setting $\gamma_{j} = -1$ can only newly violate constraint (5) for $\gamma_{j}$, meaning that $t_j$ is in an \lcycle. 

    Otherwise, if $t_j$ is an assignment transition, let $t_{at(k)}$ be the latest assignment transition after $t_{i}$ such that for all $j\leq at(l)< at(k)$, $\gamma_{at(l)} =0$ and $c_{at(k)} = \lguard[\texttt{x}]$. Then there must exist some $at(l), j\leq at(l)< at(k)$ such that setting $\gamma_{at(l)}=-1$ would newly violate constraint (1) for some non-assignment $\gamma_{l'}$ where $at(l') = at(l)$; as before, this means that $t_{l'}$ is in an \lcycle.  

    Thus, if $\gamma_i =0$, then there is $\texttt{AL}$-path from $t_i$ to some other transition that has guard $\lguard[\texttt{x}]$ and outputs $\texttt{insample}$. Otherwise, if $\gamma_i = 1$, there is an $\texttt{AL}$-path from $t_i$ to some other transition that is in an \lcycle. 

    \textbf{Case 1.2.3.2.1: Setting $\gamma_{at(i)} = \gamma_i$ would violate constraint (1) for $\gamma_{at(i)}$}

    Let $t_{at(j)}$ be the earliest assignment transition before $t_{at(i)}$ such that for all $at(j)\leq at(k)< at(i)$, $\gamma_{at(k)} =-1$ and $c_{at(k)} = \lguard[\texttt{x}]$. Then there must exist some $at(k), at(j)\leq at(k)< at(i)$ such that setting $\gamma_{at(k)}=\gamma_i$ would newly violate constraint (2) for some non-assignment $\gamma_l$ where $at(l) = at(k)$.

    First note that $c_l = \gguard[\texttt{x}]$ and there is an $\texttt{AL}$-path from $t_l$ to $t_i$. 
    
    If $\gamma_i = 0$, then setting $\gamma_l = \gamma_{at(k)} = \gamma_i = 0$ can only newly violate constraint (5) for $\gamma_l$. Thus, $\gamma_l$ is in a \gcycle. Since $\gamma_i = 0$, there exists some $t_{l'}$ such that there is an $\texttt{AL}$-path from $t_i$ to $t_{l'}$ and $t_{l'}$ has guard $\lguard[\texttt{x}]$ and outputs $\texttt{insample}$. Thus, there is an $\texttt{AL}$ path from $t_l$ to $t_{l'}$, and so there is a privacy violating path from $t_l$ to $t_{l'}$. 
    
    If $\gamma_i = 1$, then setting $\gamma_l = \gamma_{at(k)} = \gamma_i = 1$ can newly violate constraints (3) or (5) for $\gamma_l$. Further, since $\gamma_i =1$, there exists some $t_{l'}$ such that there is an $\texttt{AL}$-path from $t_i$ to $t_{l'}$ and $t_{l'}$ is in an \lcycle. Thus, there is an $\texttt{AL}$ path from $t_l$ to $t_{l'}$.
    
    If constraint (3) is newly violated, then $t_l$ is a transition with guard $\gguard[\texttt{x}]$ that outputs $\texttt{insample}$. Thus, there is a privacy violating path from $t_l$ to $t_{l'}$. 

    If constraint (5) is newly violated, then $t_l$ is in a \gcycle. Thus, there is a leaking pair composed of the cycles containing $t_l$ and $t_{l'}$, respectively.

    \textbf{Case 1.2.3.2.2: Setting $\gamma_{at(i)}=\gamma_i$ would violate constraint (3) for $\gamma_{at(i)}$}

    First, $t_{at(i)}$ is an assignment transition that outputs $\texttt{insample}$. Since $\gamma_i = 1$, there exists some $t_j$ such that there is an $\texttt{AL}$-path from $t_{at(i)}$ to $t_j$ and $t_j$ is in an \lcycle. Then there is a privacy violating path from $t_{at(i)}$ to $t_j$.

    \textbf{Case 1.2.3.2.3: Setting $\gamma_{at(i)}=\gamma_i$ would violate constraint (2) for some $\gamma_j$ such that $at(j) = at(i)$}

    Observe that $t_j$ is not an assignment transition and has guard $\gguard[\texttt{x}]$. Additionally, there is an $\texttt{AL}$-path from $t_j$ to $t_i$ since there are no assignments between $t_j$ and $t_i$. 

    If $\gamma_i =0$, then setting $\gamma_j = \gamma_{at(i)} = 0$ can only newly violate constraint (5) for $\gamma_j$. Thus, $\gamma_j$ is in a \gcycle. Since $\gamma_i = 0$, there exists some $t_{k}$ such that there is an $\texttt{AL}$-path from $t_i$ to $t_{k}$. Thus, there is an $\texttt{AL}$ path from $t_j$ to $t_{k}$, and so there is a leaking pair composed of the cycles containing $t_j$ and $t_{k}$, respectively. 

    If $\gamma_i = 1$, then setting $\gamma_j = \gamma_{at(i)}=1$ can newly violate constraints (3) or (5) for $\gamma_l$. Further, since $\gamma_i =1$, there exists some $t_{k}$ such that there is an $\texttt{AL}$-path from $t_i$ to $t_{k}$ and $t_{k}$ is in an \lcycle. Thus, there is an $\texttt{AL}$ path from $t_j$ to $t_{k}$.
    
    If constraint (3) is newly violated, then $t_j$ is a transition with guard $\gguard[\texttt{x}]$ that outputs $\texttt{insample}$. Thus, there is a privacy violating path from $t_j$ to $t_{k}$. 

    If constraint (5) is newly violated, then $t_j$ is in a \gcycle. Thus, there is a leaking pair composed of the cycles containing $t_j$ and $t_{k}$, respectively.

    \textbf{Case 2: (2) is unsatisfied for $\gamma_i$}

    This case is exactly symmetric to case (1).

    \textbf{Case 3: (3) is unsatisfied for $\gamma_i$}

    First note that if $t_i$ is in a cycle, then that cycle will be a disclosing cycle because $t_i$ outputs $\texttt{insample}$. Thus, we will assume that $t_i$ is not in a cycle.

    Because $C$ is maximal, setting $\gamma_i=0$ must violate at least one of constraints (1) or (2) for $\gamma_i$ or (1) for some $\gamma_l$ such that $at(l) = i$.

    \textbf{Case 3.1: Satisfying (3) for $\gamma_i$ would violate (1) for $\gamma_i$}

    This means that $\gamma_{at(i)}<0\implies \gamma_{at(i)} = -1$. Further, $c_i = \lguard[\texttt{x}]$. Then changing $\gamma_{at(i)}=0$ can newly violate constraints (1) or (5) for $\gamma_{at(i)}$ or constraint (2) for some $\gamma_j$ such that $at(j) = at(i)$.

    If constraint (5) is newly violated, then $t_{at(i)}$ is in a cycle. In particular, the cycle must be a leaking cycle; if $t_i$ and $t_{at(i)}$ are both contained in a cycle, then it must be leaking because $c_i = \lguard[\texttt{x}]$. Otherwise, there still must be some transition in the cycle containing $t_{at(i)}$ that has a non-$\texttt{true}$ guard since otherwise a path from $t_{at(i)}$ to $t_i$ could not exist. 

    By similar reasoning, we can assume that for every assignment transition $t_{at(j)}$before $t_{at(i)}$ on a initialized path to $t_i$, $t_{at(j)}$ is not in a cycle. 

    If constraint (1) is newly violated for $\gamma_{at(i)}$, then $c_{at(i)} = \lguard[\texttt{x}]$. Let $t_{at(j)}$ be the earliest assignment transition before $t_{at(i)}$ such that $\gamma_{at(l)} = -1$ and for all assignment transitions $t_{at(k)}$ between $t_{at(j)}$ and $t_{at(i)}$, $c_{at(k)} = \lguard[\texttt{x}]$ and $\gamma_{at(k)} = -1$. 
    
    Then there must exist some assignment transition $t_{at(k)}$, $at(j)\leq at(k)\leq at(i)$ between $t_{at(j)}$ and $t_{at(i)}$ such that setting $\gamma_{at(k)} = 0$ would newly violate constraint (2) for some $l$ where $at(l) = at(k)$. In particular, this must be because $t_l$ is in a cycle and setting $\gamma_l = 0$ would violate constraint (5). Thus, $t_l$ is in a $\texttt{G}$-cycle. Then there is an $\texttt{AL}$-path from $t_l$ to $t_i$, creating a privacy violating path from $t_l$ to $t_i$. 

    If changing $\gamma_{at(i)}$ from $-1$ to $0$ means that constraint (2) would be newly violated for some $\gamma_j$ such that $at(j) = at(i)$, note that $\gamma_j < 0$ and $c_j = \gguard[\texttt{x}]$. 
    
    So setting $\gamma_j = 0$ can violate either (2) for some $\gamma_l$ where $at(l) = j$ or (5) for $\gamma_j$. 

    If setting $\gamma_j = 0$ would violate constraint (2) for some $\gamma_l$ where $at(l) = j$, then let let $t_{at(m)}$ be the latest assignment transition after $t_{at(j)}$ such that $\gamma_{at(m)} = -1$ and for all assignment transitions $t_{at(k)}$ between $t_{at(j)}$ and $t_{at(m)}$, $c_{at(k)} = \gguard[\texttt{x}]$ and $\gamma_{at(k)} = -1$. 
    
    Then there must exist some assignment transition $t_{at(k)}$, $at(j)\leq at(k)\leq at(m)$ between $t_{at(j)}$ and $t_{at(m)}$ such that setting $\gamma_{at(k)} = 0$ would newly violate constraint (2) for some $l'$ where $at(l') = at(k)$. 
    In particular, this must be because $t_{l'}$ is in a cycle and setting $\gamma_l = 0$ would violate constraint (5). Thus, $t_l$ is in a $\texttt{G}$-cycle. Then there is an $\texttt{AG}$-path from $t_i$ to $t_l$, creating a privacy violating path from $t_i$ to $t_l$. 

    Otherwise, if setting $\gamma_j = 0$ would violate constraint (5) for $\gamma_j$, then $t_j$ is in a $\texttt{G}$-cycle. We can assume that $j\neq i$ because otherwise, the cycle containing $t_j$ would be a disclosing cycle. Additionally, note that there are no assignment transitions between $t_i$ and $t_j$ or vice versa, since $at(j) = at(i)$.
    Thus, if $j<i$, then there is an $\texttt{AL}$-path from $t_j$ to $t_i$, which forms a privacy violating path. Symmetrically, if $i<j$, then there is an $\texttt{AG}-$path from $t_i$ to $t_j$, which again forms a privacy violating path. 

    \textbf{Case 3.2: Satisfying (3) for $\gamma_i$ would violate (2) for $\gamma_i$}

    This case is exactly symmetric to case (3a).

    \textbf{Case 3.3: Satisfying (3) for $\gamma_i$ would violate (1) for some $\gamma_l$ where $at(l) = i$}

    Note that $t_i$ must be an assignment transition. Further, we know that $\gamma_l>0$ and $c_l = \lguard[\texttt{x}]$. 
    
    Because $C$ is maximal, setting $\gamma_l=0$ would now violate either constraint (1) for some $\gamma_{l'}$ where $at(l') = l$ or constraint (5) for $\gamma_l$. Note that because $\gamma_l>0$, constraint (2) cannot be newly violated for some $\gamma_{l'}$ where $at(l') = l$.

    If constraint (5) would be newly violated for $\gamma_l$, then $\gamma_l$ is in an $\texttt{L}$-cycle. Additionally, note that the path from $t_{i+1}$ to $t_l$ is an $\texttt{AL}$-path, so there is a privacy violating path from $t_i$ to $t_l$. 

    Otherwise, if setting $\gamma_l = 0$ would violate constraint (1) for some $\gamma_{l'}$ where $at(l')=l$, let $t_{at(j)}$ be the latest assignment transition such that $c_{at(j)} = \lguard[\texttt{x}]$ and $\gamma_{at(j)}<1$ and, for all assignment transitions $t_{at(k)}$ between $t_l$ and $t_{at(j)}$, $c_{at(k)} = \lguard[\texttt{x}]$ and $\gamma_{at(k)}<1$. 

    If $at(j) = l$, then $l'$ is not an assignment transition. Then, setting $\gamma_{l'} = 0$ could only violate constraint (5). In this case, as before, there is a privacy violating path from $t_i$ to $t_l$. 

    Otherwise, since $C$ is maximal, we cannot set $\gamma_{at(k)}=0$ for any $l<at(k)\leq at(j)$ without violating another constraint. In particular, there must be some $at(k)$ such that setting $\gamma_{at(k)} = 0$ would violate constraint (1) for some $\gamma_{k'}$ such that $at(k') = at(k)$. Note that there must be an \texttt{AL}-path from $t_i$ to $t_{k'}$. Then, as before, there must be a privacy violating path from $t_i$ to $t_{k'}$. 


    \textbf{Case 3.4: Satisfying (3) for $\gamma_i$ would violate (2) for some $\gamma_l$ where $at(l) = i$} 

    This case is exactly symmetric to case (3c).

    \textbf{Case 4: (4) is unsatisfied for $\gamma_i'$}
    
    Because $C$ is maximal, setting $\gamma_i'=0$ must violate some other constraint. In particular, this must mean that constraint (6) is now violated. However, this would imply that $t_i$ is in a cycle, and so the cycle containing $t_i$ would be a disclosing cycle.

    \textbf{Case 5: (5) is unsatisfied for $t_i$:} Because $C$ is maximal, we know that if $\gamma_i = -\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}$ then another constraint must be violated. In particular, at least one of constraints (1), (2), or (3) must be violated for $\gamma_i$. 
    
    \textbf{Case 5.1: Satisfying (5) for $t_i$ would violate (1)}

    If (1) is now violated, then either $t_i$ is an assignment transition or $c_i = \lguard[\texttt{x}]$ and $\gamma_{at(i)}<1$. If $t_i$ is an assignment transition, then the cycle containing $t_i$ has a transition with a non-$\texttt{true}$ guard ($t_i$) and an assignment transition, so it must be a leaking cycle. 

    Otherwise, if $t_i$ is not an assignment transition, $c_i = \lguard[\texttt{x}]$, and constraint (1) is violated for $\gamma_i$, we must have that $\gamma_{at(i)}<1$ due to other constraints.
    
    Consider all assignment transitions in $\rho$ before $t_i$. Note that if any such assignment transition is in a cycle, then that cycle must be a leaking cycle since either the assignment transition is in the same cycle as $t_i$ or there must be some non-$\texttt{true}$ transition in the cycle because otherwise $t_i$ is unreachable.

    So assume that all assignment transitions in $\rho$ before $t_i$ are not in a cycle. Then if $c_{at(i)} \neq \lguard[\texttt{x}]$, because $C$ is maximal, this must mean that $t_{at(i)}$ outputs $\texttt{insample}$. Note that the path from $t_{at(i)+1}$ to $t_i$ is an $\texttt{AL}$-path (since there are no assignment transitions on it) and $t_i$ is in an $\texttt{L}$-cycle since $t_i$ is in a cycle and $c_i = \lguard[\texttt{x}]$. 
    Then the path from $t_{at(i)}$ (an assignment transition that outputs $\texttt{insample}$) to $t_i$ is a privacy violating path. 

    If $c_{at(i)} = \lguard[\texttt{x}]$, then let $c_{at(j)}$ be the earliest assignment transition such that $c_{at(j)} = \lguard[\texttt{x}]$ and $\gamma_{at(j)} < 1$ and, for all assignment transitions $t_{at(k)}$ between $t_{at(j)}$ and $t_i$, $c_{at(k)} = \lguard[\texttt{x}]$ and $\gamma_{at(k)} < 1$. Note that such an $t_{at(j)}$ must exist. 

    If $t_{at(j)} = t_{at(i)}$, then setting $\gamma_{at(i)} =1$ must violate either constraint (2) for some other $\gamma_l$ such that $at(l)=at(i)$, or constraint (3) for $\gamma_{at(i)}$. Without loss of generality, we will assume that $l\neq i$. If constraint (3) would be violated, then as before, there exists a privacy violating path from $t_{at(j)}$ to $t_i$. 
    If constraint (2) would be violated for some $\gamma_l$ such that $at(l)=at(i)$, then either $t_l$ must output $\texttt{insample}$ or $t_l$ must be in a cycle. 
    
    Suppose that $i<l$; then that the path from $t_i$ to $t_l$ is both an $\texttt{AG}$-path and an $\texttt{AL}$-path (since there are no assignment transitions on it). Thus, if $t_l$ outputs $\texttt{insample}$, there exists a privacy violating path from $t_i$ to $t_l$ and if $t_l$ is in a cycle, then the cycle containing $t_i$ and the cycle containing $t_l$ together make up a leaking pair, since the cycle containing $t_l$ is a $\texttt{G}$-cycle by definition. 
    Symmetrically, if $l>i$, then either the path from $t_l$ to $t_i$ is a privacy violating path or the cycle containing $t_l$ and the cycle containing $t_i$ make up a leaking pair.
    
    Otherwise, note that the path from $t_{at(j)}$ to $t_i$ is an $\texttt{AL}-$path. Since $C$ is maximal, we cannot set $\gamma_{at(k)}=1$ for $\gamma_{at(j)}$ or for any of the other assignment transitions $t_{at(k)}$ between $t_{at(j)}$ and $t_i$ without violating another constraint. 
    In particular, there must be some $t_{at(k)}$ where $at(j)\leq at(k)<i$ such that setting $\gamma_{at(k)} = 1$ would mean that either constraint (2) for some $\gamma_l$ such that $at(l) = at(k)$ or constraint (3) would be violated for $\gamma_{at(k)}$. 
    If constraint (3) would be violated for $\gamma_{at(k)}$ then $t_{at(k)}$ outputs $\texttt{insample}$, so as before, there is a privacy violating path from $t_{at(k)}$ to $t_i$. Otherwise if constraint (2) would be violated for some $\gamma_l$ such that $at(l) = at(k)$, then as before, $\gamma_l$ must either output $\texttt{insample}$ or $t_l$ is in a cycle. 
    Just like before, this means that there must be either a privacy violating path from $t_l$ to $t_i$ or the cycle containing $t_l$ and the cycle containing $t_i$ together make up a leaking pair. 

    \textbf{Case 5.2: Satisfying (5) for $t_i$ would violate (2)}

    This case is exactly symmetric to case (5a).

    \textbf{Case 5.3: Satisfying (5) for $t_i$ would violate (3)}

    If (3) would be violated, then $t_i$ must output $\texttt{insample}$ and be a non-public transition. Then the cycle containing $t_i$ must be a disclosing cycle. 
    
    \textbf{Case 6: (6) is unsatisfied for $t_i$:} Because $C$ is maximal, we know that if $\gamma_i' = -\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}$ then another constraint must be violated for $\gamma_i'$. In particular, constraint (4) must be violated, since no other constraint involves $\gamma_i'$. 
    Then $t_i$ is a transition in a cycle that outputs $\texttt{insample}'$, so $A$ has a disclosing cycle.
\end{proof}


\subsection{Minimizing Coupling Cost}

\begin{prop}\label{costDependspathProp}
    There exist SLPs $\rho'=\pi\cdot \pi$, $\rho^*=\pi\cdot\pi^*$ that share a prefix SLP $\pi$ such that for all optimal coupling strategies $C'$ for $\rho'$ and $C^*$ for $\rho^*$, $C'$ and $C^*$ differ on the shift assigned to some transition in $\pi$. 

    In other words, the optimal strategy $C$ must assign different coupling strategies to occurances of the same transition in different SLPs. 
\end{prop}

\begin{proof}
    First, we define the following transitions that we use to construct our counterexample:
    \begin{align*}
        t_{init} &= (\texttt{true}, \bot, \texttt{true})\\
        t_{geq1} &= (\gguard[\texttt{x}], \top, \texttt{false})\\
        t_{leq1} &= (\lguard[\texttt{x}], \bot, \texttt{false})\\
        t_{geq2} &= (\gguard[\texttt{x}], \top, \texttt{false})\\
        t_{leq2} &= (\lguard[\texttt{x}], \bot, \texttt{false})
    \end{align*}

    For all transitions $t$, let $P(t) = (1, 1)$.

    Let $\rho_1 = t_{init}t_{geq1}t_{geq2}^n$ and $\rho_2 = t_{init}t_{leq1}t_{leq2}^n$, where $n\in \NN$. Observe that $\rho_1$ and $\rho_2$ share the prefix $t_{init}$. 
    
    We make the following observations: 
    \begin{itemize}
        \item The cost of any coupling strategy for $\rho_1$ or $\rho_2$ must be at least 2:
        
        Let $C_{\rho_1} = (\gamma, \gamma')$ be a coupling strategy for $\rho_1$. We can bound its cost as follows: 
        \begin{align*}
            cost(C_{\rho_1}) &= \max_{\texttt{in}\brangle{1}\sim\texttt{in}\brangle{2}}\sum_{i=0}^{n+2}(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i(\texttt{in}_i\brangle{1}, \texttt{in}_i\brangle{2}))\\&\qquad+(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i'(\texttt{in}_i\brangle{1}, \texttt{in}_i\brangle{2})|)\\
            &\geq \max_{\texttt{in}\brangle{1}\sim\texttt{in}\brangle{2}} \sum_{i=0}^{n+2}(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i(\texttt{in}_i\brangle{1}, \texttt{in}_i\brangle{2})|)\\
            &= \max_{\Delta \in [-1, 1]^{n+2}} \sum_{i=0}^{n+2}(|\Delta_i-\gamma_i(0, \Delta_i)|)\\
            &\geq |1 - \gamma_0(0, 1)| + \sum_{i=1}^{n+2}|-1-\gamma_i(0, -1)|\\
            &= 1 - \gamma_0(0, 1) + \sum_{i=1}^{n+2} (1+\gamma_i(0, -1))\\
            &= 1 - \gamma_0(0, 1) + (n + 2) + \sum_{i=1}^{n+2}\gamma_i(0, -1)\\
            &\geq 1 - \gamma_0(0, 1) + (n + 2) + \sum_{i=1}^{n+2}\gamma_0(0, 1) \qquad \text{(privacy constraint)}\\
            &= (n + 3) + (n + 1) \gamma_0(0, 1)\\
            &\geq 2
        \end{align*}

    and by a similar argument, $cost(C_{\rho_2})\geq 2$ for any coupling strategy $C_{\rho_2}$ for $\rho_2$. 

    \item There exist coupling strategies $C_{\rho_1}^*$ and $C_{\rho_2}^*$ for $\rho_1$ and $\rho_2$, respectively, such that $cost(C_{\rho_1}^*) = cost(C_{\rho_2}^*) = 2$. 
    
    We will first describe $C_{\rho_1}^* = (\gamma, \gamma')$. Since no transition outputs \texttt{insample}, we can set $\gamma_i'(\texttt{in}\brangle{1}, \texttt{in}\brangle{2}) = \texttt{in}\brangle{2} - \texttt{in}\brangle{1}$ for all $i$ with no privacy cost. Define 
    \begin{align*}
        \gamma_0(\texttt{in}\brangle{1}, \texttt{in}\brangle{2}) &= -1 \\
        \gamma_i(\texttt{in}\brangle{1}, \texttt{in}\brangle{2}) &= \texttt{in}_i\brangle{2} - \texttt{in}_i\brangle{1} \qquad \text{for all $i>0$}
    \end{align*}
    We see that $C^*_{\rho_1}$ is valid, since $\gamma_i\geq \gamma_{0}$ for all $i>0$. Further, we see that 
    \begin{align*}
        cost(C^*_{\rho_1}) &= \max_{\texttt{in}\brangle{1}\sim\texttt{in}\brangle{2}}\sum_{i=0}^{n+2}(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i(\texttt{in}_i\brangle{1}, \texttt{in}_i\brangle{2}))\\&\qquad+(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i'(\texttt{in}_i\brangle{1}, \texttt{in}_i\brangle{2})|)\\
        &= \max_{\texttt{in}\brangle{1}\sim\texttt{in}\brangle{2}} |-\texttt{in}_0\brangle{1}+\texttt{in}_0\brangle{2}-\gamma_0(\texttt{in}_0\brangle{1}, \texttt{in}_0\brangle{2})| \\
        &= \max_{\texttt{in}\brangle{1}\sim\texttt{in}\brangle{2}} |-\texttt{in}_0\brangle{1}+\texttt{in}_0\brangle{2}+1|\\
        &\leq 2 
    \end{align*}
    showing that $cost(C^*_{\rho_1}) = 2$. Similarly, there is a coupling strategy $C^*_{\rho_2}$ for which $cost(C^*_{\rho_2}) = 2$.
    
    \item Any pair of coupling strategies $C_{\rho_1} = (\gamma^{(1)}, \gamma^{\prime(1)})$ and $C_{\rho_2}=(\gamma^{(2)}, \gamma^{\prime(2)})$ for $\rho_1$, $\rho_2$, respectively, that assign the same shifts to $t_{init}$ in both $\rho_1$ and $\rho_2$ must be such that $\max\{cost(C_{\rho_1}), cost(C_{\rho_2})\}>2$.
    
    For the sake of contradiction, suppose that $\max\{cost(C_{\rho_1}), cost(C_{\rho_2})\}=2$. Note that it is thus impossible for $\gamma_0^{(1)}(0, 1) \neq -1$, since then $cost(C_{\rho_1}) > 2$ in the same manner as above.  

    Thus, $\gamma_0^{(1)}(0, 1) = -1$ in $C_{\rho_1}$, which by hypothesis, means that $\gamma_0^{(2)}(0, 1) = -1$ as well. We have the privacy constraint $\gamma_i^{(2)} \leq \gamma_0^{(2)}$ for $i>0$, which also means that $\gamma_i = -1$ identically for all $i > 0$. However, this means that 
    \begin{align*}
        cost(C_{\rho_2}) &= \max_{\texttt{in}\brangle{1}\sim\texttt{in}\brangle{2}}\sum_{i=0}^{n+2}(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i^{(2)}(\texttt{in}_i\brangle{1}, \texttt{in}_i\brangle{2}))\\&\qquad+(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i^{\prime(2)}(\texttt{in}_i\brangle{1}, \texttt{in}_i\brangle{2})|)\\
        &\geq \max_{\texttt{in}\brangle{1}\sim\texttt{in}\brangle{2}} \sum_{i=0}^{n+2}(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i^{(2)}(\texttt{in}_i\brangle{1}, \texttt{in}_i\brangle{2})|)\\
        &\geq \max_{\Delta \in [-1, 1]^{n+2}} |\Delta_0 - \gamma_i^{(2)}(0, \Delta_0)| + \sum_{i=1}^{n+2}(|\Delta_i-\gamma_i^{(2)}(0, \Delta_i)|)\\
        &\geq |1 - \gamma_i^{(2)}(0, 1)| + \sum_{i=1}^{n+2}(|1+1|)\\
        &= 2 \cdot (n + 2)
    \end{align*}
    which is a contradiction. 

    \end{itemize}
    This completes the proof.     
\end{proof}

\begin{prop}(Precise statement of proposition \ref{quadraticPenaltyProp})
    There exist a family of sets of SLPs $\{B_n\}_{n\in \NN}$ for which the cost of any unified coupling strategy $C$ for SLPs in $B_n$ is in $\Omega(n^2)$, but for which there exist SLP-specific coupling strategies for $B_n$ such that their total cost is in $O(n)$.
\end{prop}

\begin{proof}
    We first define the following transitions for all $1\leq i\leq n$: \begin{itemize}
        \item $t_{true}^{(i)} = (\texttt{true}, \bot, \texttt{true})$
        \item $t_{geq}^{(i)} = (\gguard[\texttt{x}],\bot, \texttt{true})$
        \item $t_{leq}^{(i)} = (\lguard[\texttt{x}], \top, \texttt{false})$
        \item $t_{loop}^{(i)} = (\lguard[\texttt{x}], \top, \texttt{false})$
    \end{itemize}

    For all transitions $t$, let $P(t) = (1, 1)$. 


    Consider an SLP $\rho = t_{true}^{(1)} t_{geq}^{(1)} \left(t_{leq}^{(1)}\right)^n \dots t_{true}^{(n)} t_{geq}^{(n)} \left(t_{leq}^{(n)}\right)^n$

    For each $i$, construct also the periodic program $L_i = t_{true}^{(n + i)} \left(t_{loop}^{(i)}\right)^* t_{geq}^{(i)}$ such that each transition $t_{geq}^{(i)}$ is preceded by an arbitrary number of transitions with guard $\lguard$. In particular, we note that $t_{geq}^{(i)}$ is a transition shared by $L_i$ and $\rho$. 

    Let $B_n = \{\rho\}\cup \bigcup_{i=1}^n L_i$. It is worth noting that we do not require $B_n$ to be a set of SLPs generated by a proper CFG; it is possible to extend this construction to such a set relatively straightforwardly by creating a unique initial start transition and connecting it to the beginnings of each SLP in $B_n$.
    
    We will analyze a ``SLP-independent'' set of coupling strategies, meaning that every transition in $B_n$ must be assigned the same shifts by every coupling strategy in the set; this is specifically relevant for transitions that are shared between SLPs (here, $t_{geq}^{(i)}$). 
    For convenience, we treat this set of coupling strategies as a single coupling strategy $C$ that assigns shifts to each individual transition; $C$ induces coupling strategies for SLPs in the same manner as definition \ref{svInducedCouplingStrategy}. 

    We label shifts in $C$ for a transition $t$ as $\gamma_t, \gamma'_t$. Since none of the transitions in $B_n$ output $\texttt{insample}'$, we ignore $\gamma'_t$ for the rest of the proof. 

    There are several constraints on shifts in $C$. 

    First, consider the periodic program $L_i$. In order for $L_i$ to be private, we must have that $\gamma_{t_{true}^{n + i}}(1, 0) = 1$ from the same argument as in the proof of proposition \ref{costDependspathProp}, which then implies from the constraint $\gamma_{t_{true}^{n + i}} \leq \gamma_{t_{geq}^{(i)}}$ that $\gamma_{t_{geq}^{(i)}}(1, 0) = 1$. 

    Now, since the assignment transition immediately preceding $t_{leq}^{(i)}$ in $\rho$ is $t_{geq}^{(i)}$, for which we have the privacy constraint $\gamma_{t_{geq}^{(i)}} \leq \gamma_{t_{leq}^{(i)}}$, we see that $\gamma_{t_{leq}^{(i)}}(1, 0) = 1$ as well. 

    We can thus compute the cost of the coupling strategy $C_\rho$ that $C$ induces on $\rho$, which has $n \cdot (n + 2)$ transitions. 

    \begin{align*}
        cost(C_\rho) &\geq \max_{\Delta = \texttt{in}\brangle{2} - \texttt{in}\brangle{1}} \sum_{i=1}^{n} \big(|\Delta_{t_{true}^{(i)}} - \gamma_{t_{true}^{(i)}}(-\Delta_{t_{true}^{(i)}}, 0)| + |\Delta_{t_{geq}^{(i)}} - \gamma_{t_{geq}^{(i)}}(-\Delta_{t_{geq}^{(i)}}, 0)| \\ & \qquad \qquad \qquad \qquad + n \cdot |\Delta_{t_{leq}^{(i)}} - \gamma_{t_{leq}^{(i)}}(-\Delta_{t_{leq}^{(i)}}, 0)|\big)\\
        &\geq \sum_{i = 1}^n \left(|-1 - \gamma_{t_{true}^{(i)}}(1, 0)| + |-1 - \gamma_{t_{geq}^{(i)}}(1, 0)| + n \cdot |-1 - \gamma_{t_{leq}^{(i)}}(1, 0)|\right)\\
        &= \sum_{i = 1}^n \left(|-1 - \gamma_{t_{true}^{(i)}}(1, 0)| + |-1 - 1| + n \cdot |-1 - 1|\right)\\
        &\geq \sum_{i = 1}^n \left(2 n + 1\right)\\
        &= n \cdot (2 n + 1)
    \end{align*} 

    Note that this also provides a lower bound on the overall privacy cost of any SLP in $B_n$. 

    However, there exists an SLP-independent coupling strategy $C_\rho^* = (\gamma^*, \gamma^{'*})$ for $\rho$ that assigns
    \begin{align*}
        \gamma_{t_{true}^{(i)}}^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2}) &= -\texttt{in}\brangle{1} + \texttt{in}\brangle{2}\\
        \gamma_{t_{geq}^{(i)}}^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2}) &= 1\\
        \gamma_{t_{leq}^{(i)}}^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2}) &= -\texttt{in}\brangle{1} + \texttt{in}\brangle{2}
    \end{align*}
    Note that this satisfies the necessary privacy constraints $\gamma_{t_{true}^{(i)}}^* \leq \gamma_{t_{geq}^{(i)}}^* \geq \gamma_{t_{leq}^{(i)}}^*$ for all $i$, and that $C_\rho^*$ has cost $2n$.
    
    Similarly for any periodic program $L_i$, we can construct the coupling strategy $C_{L_i}^* = (\gamma^*, \gamma^{'*})$, which assigns

    \begin{align*}
        \gamma_{t_{true}^{(n + i)}}^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2}) &= 1\\
        \gamma_{t_{loop}^{(i)}}^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2}) &= -\texttt{in}\brangle{1} + \texttt{in}\brangle{2}\\
        \gamma_{t_{geq}^{(i)}}^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2}) &= 1
    \end{align*}

    Again, note that $C_{L_i}^*$ satisfies the privacy constraints $\gamma_{t_{geq}^{(i)}}^* \geq \gamma_{t_{true}^{(n + i)}}^* \leq \gamma_{t_{loop}^{(i)}}^*$ for all $i$, and has cost $4$.
    
    Thus, we can create a set of SLP-dependent coupling strategies for $B_n$ with maximal cost $2n$ for any SLP in $B_n$, which is a quadratic improvement over the SLP-independent case. 
\end{proof}



\begin{proof}[\proofname~of lemma \ref{finiteCostConstraintLemma}]

    ($\impliedby$)

    Let $T$ be the set of transitions $t_i$ in $L$ such that $t_i$ is \textbf{not} found under a star in $R_L$. 

    Fix a initialized SLP $\rho\in L$ and let $C_\rho$ be the coupling strategy for $\rho$ induced by $C$. 

    Let $D_\rho$ be the set of transitions $t_i\in \rho$ such that $t_i$ is under a star in $R_L$, i.e., $t_i\notin T$.  

    If the given constraint holds, then we know that $\max_{\texttt{in}\brangle{1}\sim\texttt{in}\brangle{2}}\sum_{i: t_i\in D_\rho}(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i|)d_i+(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i'|)d_i' = 0$

    So \begin{align*}
        cost(C_\rho) = \max_{\texttt{in}\brangle{1}\sim\texttt{in}\brangle{2}}&\sum_{i: t_i\in D_\rho}(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i|)d_i+(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i'|)d_i'\\
        &+\sum_{i: t_i\notin D_\rho}(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i|)d_i+(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i'|)d_i'\\
        = \max_{\texttt{in}\brangle{1}\sim\texttt{in}\brangle{2}}&\sum_{i: t_i\in T}(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i|)d_i+(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i'|)d_i'\\
        \leq \sum_{i:t_i\in T}(2d_i& + 2d_i')\\
        \leq |T|\max_{i:t_i\in T}&(2d_i + 2d_i')
    \end{align*}

    Thus, $cost(C)\leq |T|\max_{i:t_i\in T}(2d_i + 2d_i') <\infty$.

    ($\implies$)

    Let $t_i$ be a transition in $L$ under a star in $R_L$ such that $\gamma_i\neq -\texttt{in}\brangle{1}_i+\texttt{in}\brangle{2}_i$ or $\gamma_i'\neq  -\texttt{in}\brangle{1}_i+\texttt{in}\brangle{2}_i$.     Thus, $\exists \texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}$ such that $(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i|)d_i+(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i'|)d_i'>0$.
    Fix such a $\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}$. 

    Then there exists some initialized SLP $\rho$ in $L$ of the form $a(bt_ic)^*d$ for some $a, b, c, d\in \Sigma_T^*$.
    
    Let $\rho_k=a(bt_ic)^kd$ be the corresponding initialized SLP in $L$ with $(bt_ic)$ iterated $k$ times. This is equivalent to iterating the cycle containing $t_i$ $k$ times. Then for all $k\in \NN$, \begin{align*}
        cost(\rho_k) \geq k((|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i|)d_i+(|-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}-\gamma_i'|)d_i'),
    \end{align*}
    so for all $M\in \RR$, $\exists \rho_k$ such that $cost(\rho_k) > M$.
\end{proof}


\begin{lemma}\label{cycleGammaConstraints}
    If a coupling strategy $C=(\mathbf{\gamma}, \mathbf{\gamma}')$ for a periodic program $L$ is valid and has finite cost, then the following must hold for all $i$:
    \begin{enumerate}
        \item If $t_i$ is in a cycle and $c_i = \lguard[\texttt{x}]$, then $\gamma_i = -\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}$ and $\gamma_{at(i)} = 1$.
        \item If $t_i$ is in a cycle and $c_i = \gguard[\texttt{x}]$, then $\gamma_i = -\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}$ and $\gamma_{at(i)} = -1$.
    \end{enumerate}
\end{lemma}
\begin{proof}
    We will show (1). (2) follows symmetrically.

    Consider some $t_i$ in a cycle where $c_i = \lguard[\texttt{x}]$. Because $C$ is has finite cost, we know from lemma \ref{finiteCostConstraintLemma} that $\gamma_i = -\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}$ for all  $\texttt{in}_i\brangle{1}\sim\texttt{in}_i\brangle{2}$. In particular, when $-\texttt{in}_i\brangle{1}+\texttt{in}_i\brangle{2}=1$, then $\gamma_i=1$. 
    
    Further, because $\gamma_{at(i)}$ must be greater than $\gamma_i$ for all $\texttt{in}_i\brangle{1}\sim\texttt{in}_i\brangle{2}$ for $C$ to be valid, we must have that $\gamma_{at(i)}=1$.
\end{proof}

\begin{lemma}\label{integersAreEnoughForATLemma}
    If a valid finite cost coupling strategy $C = (\gamma, \gamma')$ exists for a periodic program $L_\rho$, then there exists a valid finite cost coupling strategy $C^*= (\gamma^*, \gamma^{*\prime})$ such that for all $i\in AT(L_\rho)$, $\gamma_i^*\in \{-1, 0, 1\}$. 
\end{lemma}
\begin{proof}
    Since $L_\rho$ is differentially private, the cost $opt(L_\rho)$ of its optimal coupling strategy is finite. By Proposition \ref{prop:approx_opt_are_close}, we see also that $approx(L)$ is finite. Thus, there exists $\beta \in [-1, 1]^{n}$ which satisfies the approximate privacy constraints on $L_\rho$.

    Define 
    \[\gamma_i = \lfloor \beta_i \rfloor \]

    and notice that $\gamma_i, \gamma^{\prime}$ also satisfy the approximate privacy constraints on $L_\rho$:
    \begin{align*}
        \beta_{at(i)} \leq \beta_i &\implies \lfloor \beta_{at(i)} \rfloor \leq \lfloor \beta_i \rfloor \implies \gamma_{at(i)} \leq \gamma_i\\
        \beta_{at(i)} \geq \beta_i &\implies \lfloor \beta_{at(i)} \rfloor \geq \lfloor \beta_i \rfloor \implies \gamma_{at(i)} \geq \gamma_i\\
        \beta_{i} = 0 &\implies \lfloor \beta_{i} \rfloor = 0 \implies \gamma_{i} = 0\\
        \beta_{i} = 1 &\implies \lfloor \beta_{i} \rfloor = 1 \implies \gamma_{i} = 1\\
        \beta_{i} = -1 &\implies \lfloor \beta_{i} \rfloor = -1 \implies \gamma_{i} = -1
    \end{align*}
    Since $L_\rho$ is private, none of the transitions $t_i$ for $i \in AT(L_\rho)$ are in cycles by lemma \ref{unsatisfiableImpliesNotWellformedLemma}.
    
    By Proposition \ref{prop:approx_exists}, we see that there is a valid coupling strategy $C^* = (\gamma^*, \gamma^{*\prime})$ for $\gamma^*_i = \gamma_i \in \{-1, 0, 1\}$ for all $i \in AT(L_\rho)$.
\end{proof}




\begin{proof}[Proof of prop \ref{syntacticEquivalenceProp}]
    Let $G_P = (V, E)$ be a proper control flow graph that generates an output distinct program $P$. By definition, there exists some unique starting location $\ell_{init} \in V$.

    Then let $A_P = (V, \RR, C, \Gamma, \ell_{init}, X, P_A, \delta)$ where
    \begin{itemize}
        \item $\Sigma, C, X$ are as in the definition of a DiPA
        \item $P_A, \delta$ are (partial) functions defined below.
    \end{itemize}
    
    For all states $\ell\in V$, let $T_\ell$ be the set of transitions that label edges leaving $\ell$. Because of the shared noise condition, $\forall t, t'\in T_{\ell}, P(t) = P(t')$. Let $P(t) = (d_\ell, d_\ell')$ for some $t\in T_\ell$. Then $P_A(\ell) = (0, d_\ell, 0, d_{\ell}')$.

    For all $e = (\ell, \ell')\in E$, let $T(e) = (c, \sigma, \tau)$. We define $\delta(\ell, c) = (\ell', \sigma, \tau)$.

    Observe that because $G_P$ is proper, $\delta$ is a valid transition function for $A_P$. 

    Now let $A = (Q, \Sigma, C, \Gamma, q_{init}, X, P, \delta)$ be a DiPA and let $G_A = (V, E)$ be the underlying graph of $A$; observe that $q_{init}\in V$ is a unique initial state for $G_A$. Additionally, for all $e = (q, q')\in E$, let $\delta(q, c) = (q', \sigma, \tau)$. Then $T(e) = (c, \sigma, \tau)$ is the transition labeling $e$. 

    Because $\delta$ is a valid partial transition function, $G_A$ must be a proper control flow graph that generates an output distinct program. 
\end{proof}




\begin{prop}[Proposition \ref{ClassCouplingStrategiesAreEnoughProp}]
    If there exists a valid coupling strategy $C_\rho$ with cost $cost(C_\rho)$ for every SLP $\rho$ of periodic program $L$ and $\sup_{\rho\in L}cost(C_\rho)< \infty$, then there exists a valid class coupling strategy $C'$ for $L$ such that $cost(C') \leq \sup_{\rho\in L}cost(C_\rho)$. 
\end{prop}

\begin{proof}[Proof of proposition \ref{ClassCouplingStrategiesAreEnoughProp}]


    Because $\sup_{\rho\in L}cost(C_\rho)< \infty$, we can assume that there are no leaking cycles, disclosing cycles, leaking pairs, or privacy violating paths in $L$ by lemma \ref{unsatisfiableImpliesNotWellformedLemma}.


    For a given SLP $\rho$ and a coupling strategy $C_\rho$, recall that we effectively assign each transition $t_i$ in $\rho$ the cost $\max_{\Delta \in \{-1, 0, 1\}}|\Delta - \gamma_i(\Delta)| + |\Delta' - \gamma'_i(\Delta)|$. For convenience, we will shorthand this quantity as $\delta(\rho, t_i) + \delta'(\rho, t_i)$.


    For all $n\in \NN$, let $\rho_n$ be the SLP in $L$ with every cycle in $\rho_n$ repeated $n$ times. 

   Let $cycle(L)$ be the set of all transitions in $L$ that are contained within a cycle in $L$. Observe that for all $t\in cycle(L)$, \[
        \lim_{n\to\infty}\inf_{t_i\in\rho_n: t_i=t} \delta(\rho_n, t_i) = 0
    \]
    Informally, for every cycle transition $t$ in $L$, if the cycle it is contained in is iterated enough times, there must be some iteration $t_i$ of $t$ that is assigned costs approaching 0. 

    This can be shown by considering a transition $t$ in a cycle in $L$ whose minimum coupling cost is non-zero (i.e. $\inf_{\rho\in L; t_i=t} \delta(t_i) > 0$). Then for any finite $d>0$, there exists an SLP $\rho_n$ where $n>\lceil\frac{d}{\inf\delta(t_i)}\rceil+1$. Then $cost(C_{\rho^*})>d$, which implies that $\sup_{\rho\in L}cost(C_\rho) = \infty$, so the observation must hold. 

    Let $t_i$ be a transition in a cycle in $L$ and let $\mathcal{C}_i$ be the cycle containing $t_i$. 

    Then in particular, if $\mathcal{C}_i$ contains a transition with guard $\lguard[\texttt{x}]$, then for all $\psi>0$, there exists $n\in \NN$ such that for $\rho_n\in L$, $\gamma_{at(i)}> 1-\psi$ and if $\mathcal{C}_i$ contains a transition with guard $\lguard[\texttt{x}]$, then for all $\psi>0$, $\gamma_{at(i)}> -1+\psi$. 
    Informally, assignment transitions before an \lcycle\ have shifts that approach 1 and assignment transitions before a \gcycle\ have shifts that approach -1 in $\rho_n$ as $n\to\infty$. 

    Because we know that all coupling strategies $C_{\rho}$ are valid, this may also imply that other assignment transitions also have shifts that approach 1 or -1. 

    Further, if the shifts for an assignment transition $t_i$ approach 1, then the shifts for a transition $t_j$ such that $at(j) = i$ and $c_j = \gguard[\texttt{x}]$ must also approach 1; symmetrically, if the shifts for an assignment transition $t_i$ approach -1, then the shifts for a transition $t_j$ such that $at(j) = i$ and $c_j = \lguard[\texttt{x}]$ must also approach -1. 

    Let $T_1$ and $T_{-1}$ be the sets of assignment transitions in $L$ that approach 1 and -1, respectively. 

    Note that every other transition in $L$ is a non-cycle transition. Consider such a transition $t$ in $L$. Then for every SLP $\rho\in L$ and its corresponding coupling strategy $C_\rho$, there is exactly one shift assignment for $t$ because $t$ is not in a cycle. 

    Let the coupling strategy $C' = (\gamma, \gamma')$ be partially defined as follows: \begin{align*}
        \gamma(t_i)(\texttt{in}\brangle{1}, \texttt{in}\brangle{2}) &= \begin{cases}
            1 & t_i \in T_1\\
            -1 & t_i \in T_{-1}\\
            \texttt{in}\brangle{1}-\texttt{in}\brangle{2} & c_i = \lguard[\texttt{x}]\land t_{at(i)}\in T_1\\
            \texttt{in}\brangle{1}-\texttt{in}\brangle{2} & c_i = \gguard[\texttt{x}]\land t_{at(i)}\in T_{-1}\\
            1 & c_i = \gguard[\texttt{x}]\land t_{at(i)}\in T_1\\
            -1 & c_i = \lguard[\texttt{x}]\land t_{at(i)}\in T_{-1}
        \end{cases}\\
        \gamma'(t_i)(\texttt{in}\brangle{1}, \texttt{in}\brangle{2}) &=\begin{cases}
            0 & t_i\text{ outputs }\texttt{insample}'\\
            \texttt{in}\brangle{1}-\texttt{in}\brangle{2} & \text{otherwise}
        \end{cases}
    \end{align*}

    Let $T_{un}$ be the set of transitions in $L$ that are not assigned by $\gamma$ so far. Note that all transitions in $T_{un}$ are not in cycles. 

    Let $C^* = (\gamma^*, \gamma^{*\prime})$ be the minimal-cost valid class coupling strategy such that for all $t\notin T_{un}$, $\gamma^*(t) = \gamma(t)$. 

    In other words, $cost(C^*) = \inf_{\text{all such valid coupling strategies } C} cost(C)$. Note that $C^*$ is valid. 

    We additionally claim that $cost(C^*)\leq \sup_{\rho\in L}cost(C_\rho)$. The cost of $C^*$ can be separated into costs attributed to $\gamma^{*\prime}$, costs attributed to all transitions not in $T_{un}$ by $\gamma^*$, and costs attributed to all transitions in $T_{un}$ by $\gamma^*$. 
    
    First, note that the coupling cost attributed to $\gamma^{*\prime}$ in $C^*$ must be at most the maximimum coupling cost attributed to $\gamma'$ over all SLP-specific coupling strategies. From before, we additionally know that the cost attributed to all transitions $t\notin T_{un}$ by $\gamma^*$ is at most the supremum of the costs attributed to $t$ over all SLPs in $L$, since we take the limit of all such shifts for $\rho_n$ as $n\to\infty$.

    Finally, since all SLP-specific coupling strategies are valid, taking the remaining transition shifts to minimize the overall cost while retaining a valid coupling strategy sufficies. 
\end{proof}


\begin{proof}[Proof of \ref{prop:compute_opt_cost}]
    Assume that $L$ is differentially private. Then there exists a valid coupling strategy for $L$ with finite cost, showing that the constraints above are feasible, and a finite solution to the optimization problem exists.  

    We will specify a valid coupling strategy $C^* = (\gamma^*, {\gamma'}^*)$ for $L$ with the cost stated above, and then show it is optimal. Define $\Gamma: [-1, 1]^n \to [-1, 1]^n \times [-1, 1]^n$ as follows, where $\Gamma(\Delta)$ is a pair $(\gamma, \gamma')$: 
    \begin{align*}
        \Gamma(\Delta) = &\argmin_{\gamma, \gamma' \in [-1, 1]^n} \sum_{i = 1}^n \left(|\Delta_i - \gamma_i| d_i + |\Delta_i - \gamma_i'|d_i' \right)\\ 
        \text{subject to }
        &\ \gamma_{at(i)} \leq \gamma_i \text{ if } c_i = \gguard, \\
        &\ \gamma_{at(i)} \geq \gamma_i \text{ if } c_i = \lguard, \\
        &\ \gamma_i = 0 \text{ if } \sigma_i = \texttt{insample}, \\
        &\ \gamma_i' = 0 \text{ if } \sigma_i = \texttt{insample}'\\
        &\ \gamma_i = \gamma_i'= \Delta_i \text{ if } t_i \text{ is in a cycle}
    \end{align*}
    Then define \[(\gamma^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2}), {\gamma'}^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2})) = \Gamma(\texttt{in}\brangle{1} - \texttt{in}\brangle{2})\]

    Notice the following: 

    \begin{enumerate}
        \item $C^*$ is a valid coupling strategy for $L$, since the privacy constraints on $\gamma^*$ and ${\gamma'}^*$ are satisfied by construction.
        \item $C^*$ has the cost given by the solution to the optimization problem, since 
        \begin{align*}
            cost(C^*) &= \max_{\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}} \sum_{i = 1}^n  |\texttt{in}_i\brangle{1} - \texttt{in}_i\brangle{2} - \gamma_i^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2})| d_i \\ 
            \phantom{cost(C^*)} &\phantom{=\max_{\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}}\qquad } + |\texttt{in}_i\brangle{1} - \texttt{in}_i\brangle{2} - {\gamma'}_i^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2})|d_i' \\
            &= \max_{\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}} \sum_{i = 1}^n  |\texttt{in}_i\brangle{1} - \texttt{in}_i\brangle{2} - \Gamma_1(\texttt{in}\brangle{1} - \texttt{in}\brangle{2})_i| d_i \\ 
            \phantom{cost(C^*)} &\phantom{=\max_{\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}}\qquad } + |\texttt{in}_i\brangle{1} - \texttt{in}_i\brangle{2} - \Gamma_2(\texttt{in}\brangle{1} - \texttt{in}\brangle{2})_i|d_i' \\
            &= \max_{\Delta \in [-1, 1]^n} \sum_{i = 1}^n  |\Delta_i - \Gamma_1(\Delta)_i| d_i + |\Delta_i - \Gamma_2(\Delta)_i|d_i' \\
            &= \max_{\Delta \in [-1, 1]^n} \min_{\gamma, \gamma' \in [-1, 1]^n} \sum_{i = 1}^n  |\Delta_i - \gamma_i| d_i + |\Delta_i - \gamma_i'|d_i'
        \end{align*}
        \item $C^*$ is optimal, since for any valid coupling strategy $C = (\delta, \delta')$ for $L$, we have
        \begin{align*}
            cost(C) &= \max_{\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}} \sum_{i = 1}^n  |\texttt{in}_i\brangle{1} - \texttt{in}_i\brangle{2} - \delta_i(\texttt{in}\brangle{1}, \texttt{in}\brangle{2})| d_i \\
            \phantom{cost(C)} &\phantom{=\max_{\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}}\qquad } + |\texttt{in}_i\brangle{1} - \texttt{in}_i\brangle{2} - \delta_i'(\texttt{in}\brangle{1}, \texttt{in}\brangle{2})|d_i' \\
            &\geq \max_{\Delta \in [-1, 1]^n} \sum_{i = 1}^n  |\Delta_i - \delta_i(0, \Delta_i)| d_i + |\Delta_i - \delta_i'(0, \Delta_i)|d_i' \\
            &\geq \max_{\Delta \in [-1, 1]^n} \min_{\gamma, \gamma' \in [-1, 1]^n} \sum_{i = 1}^n \left(|\Delta_i - \gamma_i| d_i + |\Delta_i - \gamma_i'|d_i' \right)\\
            &= cost(C^*)
        \end{align*}
    \end{enumerate}
    which shows that the optimization problem computes the optimal cost of a coupling strategy for $L$ that satisfies the privacy constraints.
\end{proof}


\begin{proof}[Proof of \ref{prop:approx_exists}]
    Let 
    \[\gamma = \argmin_{\gamma \in [-1, 1]^n} \sum_{i \in I} \left(1 + |\gamma_i| \right) d_i\]
    subject to the constraints above. Define $C_L = (\gamma^*, {\gamma'}^*)$ where
    \begin{align*}
        \gamma_i^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2}) &= \begin{cases}
            \texttt{in}\brangle{1}_i - \texttt{in}\brangle{2}_i &\text{ if } t_i \text{ is in a cycle} \\
            \gamma_i &\text{ otherwise}
        \end{cases} \\[1em]
        {\gamma'}_i^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2}) &= \begin{cases}
            0 &\text{ if } t_i \text{ outputs \texttt{insample}} \\
            \texttt{in}\brangle{1}_i - \texttt{in}\brangle{2}_i &\text{ otherwise}
        \end{cases}
    \end{align*}
    Notice the following: 

    \begin{itemize}
        \item $C_L$ satisfies the privacy constraints, and so is valid.
        
        If $t_i$ is in a cycle with $c_i = \lguard$, then the constraints on $\gamma$ require that $\gamma_i = 1$, and so $1 = \gamma_i \leq \gamma_{at(i)} = 1$. As a result, we will satisfy the privacy constraint $\gamma_{at(i)}^* \geq \gamma_i^*$: 
        \[\gamma_i^* = \texttt{in}\brangle{1}_i - \texttt{in}\brangle{2}_i \leq 1 = \gamma_{at(i)}^*\]
        A similar argument holds for if $t_i$ is in a cycle with $c_i = \gguard$.

        All other privacy constraints are satisfied by construction.

        \item $C_L$ has the cost given by the solution to the optimization problem, since
        
        \begin{align*}
            cost(C_L) &= \max_{\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}} \sum_{i = 1}^n  |\texttt{in}_i\brangle{1} - \texttt{in}_i\brangle{2} - \gamma_i^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2})| d_i \\ 
            \phantom{cost(C_L)} &\phantom{=\max_{\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}}\qquad } + |\texttt{in}_i\brangle{1} - \texttt{in}_i\brangle{2} - {\gamma'}_i^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2})|d_i' \\
            &= \max_{\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}} \left(\sum_{i \in I} |\texttt{in}_i\brangle{1} - \texttt{in}_i\brangle{2} - \gamma_i^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2})| d_i\right) \\
            \phantom{cost(C_L)} &\phantom{=\max_{\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}}\qquad } + \left(\sum_{t_i \text{outputs \texttt{insample}}}|\texttt{in}_i\brangle{1} - \texttt{in}_i\brangle{2} - {\gamma'}_i^*(\texttt{in}\brangle{1}, \texttt{in}\brangle{2})|d_i'\right)\\
            &= \max_{\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}} \left(\sum_{i \in I} |\texttt{in}_i\brangle{1} - \texttt{in}_i\brangle{2} - \gamma_i| d_i\right) \\
            \phantom{cost(C_L)} &\phantom{=\max_{\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}}\qquad } + \left(\sum_{t_i \text{outputs \texttt{insample}}}|\texttt{in}_i\brangle{1} - \texttt{in}_i\brangle{2}|d_i'\right)\\
            &= \sum_{i \in I} (1 + |\gamma_i|) d_i + \sum_{t_i \text{outputs \texttt{insample}}} d_i' \\
            &= approx(L)
        \end{align*}
    \end{itemize}
\end{proof}

\begin{proof}[Proof of \ref{approximateSolutionPolyTimeProp}]
    To compute the solution to the minimization problem, we can set up the following linear program: 
    \begin{align*}
        \min_{\gamma, A_i \in [-1, 1]^n} &\sum_{i = 1}^n \left(1 + A_i \right) d_i \\ 
            \text{subject to } 
            &\ \gamma_{at(i)} \leq \gamma_i \text{ if } c_i = \lguard, \\
            &\ \gamma_{at(i)} \geq \gamma_i \text{ if } c_i = \gguard, \\
            &\ \gamma_i = 0 \text{ if } \sigma_i = \texttt{insample}, \\
            &\ \gamma_i = 1 \text{ if } t_i \text{ is in a cycle and has } c_i = \lguard,\\ 
            &\ \gamma_i = -1 \text{ if } t_i \text{ is in a cycle and has } c_i = \gguard,\\
            &\ \gamma_i \leq A_i, -\gamma_i \leq A_i \text{ for all } i \in \{1, \dots, n\} 
    \end{align*}
    This program can be solved using the ellipsoid method in polynomial time.
\end{proof}


\begin{proof}[Proof of \ref{prop:approx_opt_are_close}]
    We have $opt(L) \leq approx(L)$ by Proposition \ref{prop:compute_opt_cost}. Let $I$ be the set of transitions in $L$ that do $\textit{not}$ appear in a cycle. Then we have
    \begin{align*}
        opt(L) &= \max_{\Delta \in [-1, 1]^n} \min_{\gamma, \gamma' \in [-1, 1]^n} \sum_{i = 1}^n \left(|\Delta_i - \gamma_i| d_i + |\Delta_i - \gamma_i'|d_i' \right)\\
        &= \max_{\Delta \in [-1, 1]^n} \min_{\gamma, \gamma' \in [-1, 1]^n} \sum_{i \in I} \left(|\Delta_i - \gamma_i| d_i + |\Delta_i - \gamma_i'|d_i' \right)\\
        &= \max_{\Delta \in [-1, 1]^n} \min_{\gamma, \gamma' \in [-1, 1]^n} \left(\sum_{i \in I} \left(|\Delta_i - \gamma_i| d_i \right) + \sum_{t_i \text{outputs \texttt{insample}}} |\Delta_i| d_i' \right)\\
        &\geq \max_{\Delta \in [-1, 1]^n} \min_{\gamma, \gamma' \in [-1, 1]^n} \left(\sum_{i \in I} \left(|\gamma_i| - |\Delta_i| \right) d_i  + \sum_{t_i \text{outputs \texttt{insample}}} |\Delta_i| d_i' \right)\\
        &= \max_{\Delta \in [-1, 1]^n} \left(- \sum_{i \in I} |\Delta_i| d_i + \sum_{t_i \text{outputs \texttt{insample}}} |\Delta_i| d_i' + \min_{\gamma, \gamma' \in [-1, 1]^n} \sum_{i \in I}|\gamma_i| d_i \right)\\
        &\geq \min_{\gamma, \gamma' \in [-1, 1]^n} \sum_{i \in I}|\gamma_i| d_i \\
        &= approx(L) - \sum_{t_i \text{outputs \texttt{insample}}} d_i' - \sum_{i \in I} d_i'
    \end{align*}
    showing the second inequality.
\end{proof}


\begin{proof}[Proof of prop \ref{privacyConstraintGraphProp}]
    $(\implies)$ Let $L$ be differentially private. Then $approx(L) < \infty$, and so there exists $\gamma \in [-1, 1]^n$ such that the approximate privacy constraints are satisfied by $\gamma$. Aiming for a contradiction, assume that there exists a path ${\bf 1} \to v_{i_1} \to \dots \to v_{i_k} \to {\bf -1}$ in the privacy constraint graph of $L$. This corresponds to the sequence of privacy constraint inequalities
    \[1 \leq \gamma_{i_1} \leq \dots \leq \gamma_{i_k} \leq -1\]
    which is a contradiction, showing that no such $\gamma$ could exist. Therefore, there is no path from $\bf 1$ to $\bf -1$ in the privacy constraint graph of $L$.

    $(\impliedby)$ Let there exist no path from $\bf 1$ to $\bf -1$ in the privacy constraint graph of $L$. Define 
    \begin{align*}
        \gamma_i = \begin{cases}
            1 &\text{ if there exists a path from } {\bf 1} \text{ to } v_i \text{ in } G_L \\
            -1 &\text{ otherwise}
        \end{cases}
    \end{align*}
    We claim that the approximate privacy constraints are satisfied by $\gamma$.
    
    \begin{itemize}
        \item Consider the approximate privacy constraint $\gamma_i \leq \gamma_j$. This corresponds to the edge $(v_i, v_j)$ in $G_L$. If $\gamma_i = 1$, there is a path from $\bf 1$ to $v_i$, and so there is a path from $\bf 1$ to $v_j$, and so $\gamma_j = 1$, satisfying the constraint. If $\gamma_i = -1$, then any assignment of $\gamma_j$ satisfies the constraint. 
        \item Consider the constraint $\gamma_i = 1$. This corresponds to the edge $({\bf 1}, v_i)$ in $G_L$. Since there is a path from $\bf 1$ to $v_i$, we have $\gamma_i = 1$, satisfying the constraint.
        \item Consider the constraint $\gamma_i = -1$. This corresponds to the edge $(v_i, {\bf -1})$ in $G_L$. Since there is no path from $\bf 1$ to $\bf -1$ in $G_L$, there must be no path from $\bf 1$ to $v_i$. Thus, $\gamma_i = -1$, satisfying the constraint.
    \end{itemize}
    
    Thus, the approximate privacy constraints are satisfied by $\gamma$, which means that $approx(L) < \infty$ and $L$ is differentially private.
\end{proof}

\textbf{The following claims help prove prop \ref{programPrivacyConstraintGraphPathReq} and theorem \ref{LinearTimeDecidingPrograms}}

\begin{prop}
    \label{prop:paths_in_privacy_graph}
    Let $v_{i_0}, \dots, v_{i_k}$ be vertices in $G_P$ corresponding to transitions $t_{i_0}, \dots, t_{i_k}$ in $P$. If $v_{i_0} \to \dots \to v_{i_k}$ is a path in $G_P$, then there exists an SLP $\rho \in P$ such that 
    \begin{align*}
        t_{i_0} \cdots t_{i_k} \text{ is a subsequence of } \rho \text{ with } guard(t_{i_j}) = \gguard \text { for all } j \in \{1, \dots, k\}
    \end{align*}
    or
    \begin{align*}
        t_{i_k} \cdots t_{i_0} \text{ is a subsequence of } \rho \text{ with } guard(t_{i_j}) = \lguard \text { for all } j \in \{k - 1, \dots, 0\}
    \end{align*}
\end{prop}



\begin{proof}[Proof of \ref{prop:paths_in_privacy_graph}]
    We will use induction on the length of the path $v_{i_0} \to \dots \to v_{i_k}$ in $G_P$. 

    \begin{itemize}
        \item Base Case ($k = 1$)
        
        If $k = 1$, then the path $v_{i_0} \to v_{i_1}$ comprises of a single edge $(v_{i_0}, v_{i_1})$ in $G_P$. So, there is a periodic program $L$ for which $(v_{i_0}, v_{i_1}) \in G_L$, for which there is the privacy constraint $\gamma_{i_0} \leq \gamma_{i_1}$. 
        
        We either have that $i_0 = at(i_1)$ and $c_{i_1} = \gguard$, or $i_1 = at(i_0)$ and $c_{i_0} = \lguard$. In the first case, we have that $t_{i_0} t_{i_1}$ is a subsequence of some SLP $\rho$ in $L$ with $guard(t_{i_1}) = \gguard$. In the second case, we have that $t_{i_1} t_{i_0}$ is a subsequence of some SLP $\rho$ in $L$ with $guard(t_{i_0}) = \lguard$.

        \item Inductive Step ($k > 1$)
        
        By the inductive hypothesis, we have one of the following cases: 

        \begin{enumerate}
            \item There exists an SLP $\rho_1 \in P$ such that $t_{i_0} \cdots t_{i_{k - 1}}$ is a subsequence of $\rho_1$ with $guard(t_{i_j}) = \gguard$ for all $j \in \{1, \dots, k - 1\}$.
            
            Since we have the edge $(v_{i_{k - 1}}, v_{i_k})$ in $G_P$, there exists a periodic program $L$ for which $(v_{i_{k - 1}}, v_{i_k}) \in G_L$, for which there is the privacy constraint $\gamma_{i_{k - 1}} \leq \gamma_{i_k}$.

            We either have that $i_{k - 1} = at(i_k)$ and $c_{i_k} = \gguard$ ($t_{i_{k - 1}}$ precedes $t_{i_k}$ in $L$), or $i_k = at(i_{k - 1})$ and $c_{i_{k - 1}} = \lguard$ ($t_{i_k}$ precedes $t_{i_{k - 1}}$ in $L$). Notice, however, that we cannot have that $t_{i_k}$ precedes $t_{i_{k - 1}}$, since we have assumed $c_{i_{k - 1}} = \gguard$. 

            So, there exists an SLP $\rho_2 \in L$ such that $t_{i_{k - 1}} t_{i_k}$ is a subsequence of $\rho_2$ with $guard(t_{i_k}) = \gguard$. 

            Let $j_1$ be the index at which $t_{i_{k - 1}}$ appears in $\rho_1$, and $j_2$ be the index at which it appears in $\rho_2$. Then, the SLP $\rho_1[:j_1] \rho_2[j_2:]$ is an SLP in $P$ such that $t_{i_0} \cdots t_{i_k}$ is a subsequence of $\rho_1[:j_1] \rho_2[j_2:]$ with $guard(t_{i_j}) = \gguard$ for all $j \in \{1, \dots, k\}$.

            \item There exists an SLP $\rho_1 \in P$ such that $t_{i_{k - 1}} \cdots t_{i_0}$ is a subsequence of $\rho_1$ with $guard(t_{i_j}) = \lguard$ for all $j \in \{k - 2, \dots, 0\}$.
            
            Similar to the argument above, we either have that $t_{i_{k - 1}}$ precedes $t_{i_k}$, or $t_{i_k}$ precedes $t_{i_{k - 1}}$ in some periodic program. We cannot have that $t_{i_{k - 1}}$ precedes $t_{i_k}$, and so $c_{i_{k - 1}}$ is forced to be $\lguard$. We can then construct an SLP $\rho \in P$ such that $t_{i_k} \cdots t_{i_0}$ is a subsequence of $\rho$ with $guard(t_{i_j}) = \lguard$ for all $j \in \{k - 1, \dots, 0\}$. 
        \end{enumerate}
    \end{itemize}

    This completes the proof. 
\end{proof}


\begin{cor}
    The path $v_{i_0} \to \dots \to v_{i_k}$ is in $G_P$ if and only if there is a periodic program $L$ in $P$ such that $v_{i_0} \to \dots \to v_{i_k}$ is a path in $G_L$.
\end{cor}

\begin{proof}[Proof of \ref{programPrivacyConstraintGraphPathReq}]
    There is a path from $\bf 1$ to $\bf -1$ in the privacy constraint graph of $P$ if and only if there is a path from $\bf 1$ to $\bf -1$ in the privacy constraint graph of some periodic program $L$ in $P$ by Proposition \ref{prop:paths_in_privacy_graph}. This is true if and only if there exists some $L$ which is not differentially private, which is true if and only if $P$ is not differentially private.
\end{proof}

\section{Multivariable Programs}


\begin{lemma}[Precise Version of lemma \ref{simplifiedMvParallelCouplingsLemma}]\label{mvParallelCouplingsLemma}
    Let $\vec{X}\brangle{1} = (X_1\brangle{1}, \ldots X_k\brangle{1})$ where $X_i\brangle{1}\sim \Lap(\mu_{x_i}\brangle{1}, \frac{1}{d_{x_i}\varepsilon})$ are independent random variables and $\vec{X}\brangle{2} = (X_1\brangle{2}, \ldots X_k\brangle{2})$ where $X_i\brangle{2}\sim \Lap(\mu_{x_i}\brangle{2}, \frac{1}{d_{x_i}\varepsilon})$ are independent random variables be representations of two possible initial values of $\vec{X}$, respectively.

    Let $t = (c, \sigma, \tau)$ be a $k$v-transition such that $P(t) = (d_t, d_t')$.

    Let $\texttt{in}\brangle{1}\sim\texttt{in}\brangle{2}$ be an arbitrary adjacent input pair and let $o\brangle{1}$, $o\brangle{2}$ be random variables representing possible outputs of $t$ given inputs $\texttt{in}\brangle{1}$ and $\texttt{in}\brangle{2}$, respectively. 

    Then $\forall \varepsilon>0$ and for all $\gamma_{x_1}, \ldots, \gamma_{x_k}, \gamma_t^{(x_1)}, \ldots, \gamma_t^{(x_k)}, \gamma_t'$ that satisfy the constraints \[
        \begin{cases}
            \gamma_t^{(x_i)}\leq\gamma_{x_i} & c = \lguard[\texttt{x}_i]\\
            \gamma_t^{(x_i)}\geq\gamma_{x_i} & c = \gguard[\texttt{x}_i]\\
            \gamma_t^{(x_i)}=0 & \sigma = \texttt{insample}^{(\texttt{x}_i)}\\
            \gamma_t'=0 & \sigma = \texttt{insample}'
      \end{cases}
      \] for all $1\leq i\leq k$, the lifting $o\brangle{1}\{(a, b): a=\sigma\implies b=\sigma\}^{\#d\varepsilon}o\brangle{2}$ is valid for 
      $d = \sum_{i=1}^k\left(|\mu_{x_i}\brangle{1}-\mu_{x_i}\brangle{2}+\gamma_{x_i}|d_{x_i}+|\texttt{in}\brangle{1}-\texttt{in}\brangle{2}+\gamma_t^{(x_i)}|d_t\right)+|\texttt{in}\brangle{1}-\texttt{in}\brangle{2}+\gamma_t'|d_t'$.
\end{lemma}
\begin{proof}
    From lemma \ref{indTransitionCoupling}, we know that if these constraints are satisfied, we can create liftings such that for all $i$, $c^{(\texttt{x}_i)}$ is satisfied in run $\brangle{1}\implies c^{(\texttt{x}_i)}$ is satisfied in run $\brangle{2}$.
    
    Because $c$ is made of conjunctions and disjunctions of all $c^{(\texttt{x}_i)}$, this means that if $c$ is satisfied in run $\brangle{1}$, then $c$ must also be satisfied in $\brangle{2}$. 

    Finally, as before, if $\sigma \in \{\texttt{insample}^{(x_1)}\ldots \texttt{insample}^{(x_k)},\texttt{insample}'\}$, then for all $\sigma$, $o\brangle{1}=\sigma \implies o\brangle{2} = \sigma$. Further, note that we only need to couple $\texttt{insample}'\brangle{1}$ and $\texttt{insample}'\brangle{2}$ once for all variables. By simply adding up the costs from lemma \ref{indTransitionCoupling}, we complete the proof.
\end{proof}


\begin{proof}[Proof of lemma \ref{mvCrossCoupling}]
    Let $P(t) = (d_t, d_t')$. For convenience, we rewrite, for all $i$, $X_i = \mu_i + \zeta_i$, where $\zeta_i\sim \Lap(0, \frac{1}{d_x\varepsilon})$. For all $i$, we also write $\texttt{insample}^{(x_i)} = \texttt{in} + z_i$, where $z \sim \Lap(0, \frac{1}{d_t\varepsilon})$ and $\texttt{insample}' = \texttt{in} + z'$, where $z' \sim \Lap(0, \frac{1}{d_t'\varepsilon})$.

    Based on lemma \ref{mvParallelCouplingsLemma}, we will assume that we have constructed the following liftings for all $i$ and are aiming to ``extend'' them: \begin{itemize}
        \item $X_i\brangle{1} +\gamma_{x_i}(=)^{\#(|\mu_i\brangle{1}-\mu_i\brangle{2}+\gamma_{x_i}|d_x\varepsilon)}X_i\brangle{2}$
        \item $\texttt{insample}^{(\texttt{x}_i)} + \gamma_t^{(x_i)}(=)^{\#(|\texttt{in}\brangle{1}-\texttt{in}\brangle{2}+\gamma_t^{(x_i)}|d_t\varepsilon)}\texttt{insample}^{(\texttt{x}_i)}\brangle{2}$
        \item $\texttt{insample}' + \gamma_t'(=)^{\#(|\texttt{in}\brangle{1}-\texttt{in}\brangle{2}+\gamma_t'|d_t'\varepsilon)}\texttt{insample}'\brangle{2}$
    \end{itemize}

    \textbf{Case 1: } For all $i\neq j$, construct the lifting $z_i\brangle{1}(=)^{\#0}z_j\brangle{1}$, which is equivalent to the lifting $\texttt{insample}^{(x_i)}\brangle{1}(=)^{\#}\texttt{insample}^{(x_j)}\brangle{1}$. In particular, this guarantees that all $\texttt{insample}^{(x_i)}\brangle{1}$ are equal to each other. 
    Additionally, for all $i\neq j$, construct the lifting $\zeta_i\brangle{1}(=)^{\#0}\zeta_j\brangle{1}$, which is equivalent to the lifting $X_i\brangle{1} - X_j\brangle{1} (=)^{\#0}\mu_i\brangle{1}-\mu_j\brangle{1}$.

    First, suppose that $X_i\brangle{1} = \mu_i\brangle{1}$ for all $i$. Then if case one is true, the proposition that ``$c$ is satisfied in run $\brangle{1}$'' must always be false; thus, the implication ``$c$ is satisfied in run $\brangle{1}\implies c$ is satisfied in run $\brangle{2}$'' must always be true.

    Now observe that for any transition guard $c$, if the boolean expression produced from $c$ by setting all $\texttt{insample}^{(\texttt{x}_i)}$ equal to each other and setting $\texttt{x}_i = \mu_i\brangle{1}$ for all $i$ is a contradiction, then for any constant $a$, the boolean expression produced from $c$ by setting all $\texttt{insample}^{(\texttt{x}_i)}$ equal to each other and setting $\texttt{x}_i = \mu_i\brangle{1}+a$ for all $i$ must also be a contradiction. 

    Thus, the liftings we have constructed are sufficient to prove the proposition ``$c$ is satisfied in run $\brangle{1}\implies c$ is satisfied in run $\brangle{2}$'', and so, if the two output conditions are also satisfied, $\PP[\vec{X}\brangle{1}, t, \texttt{in}\brangle{1}, \sigma]\leq e^{d\varepsilon}\PP[\vec{X}\brangle{2}, t, \texttt{in}\brangle{2}, \sigma]$ for 
    $d = |\mu_i\brangle{1}-\mu_i\brangle{2}+\gamma_{x_i}|d_x\varepsilon + |\texttt{in}\brangle{1}-\texttt{in}\brangle{2}+\gamma_t^{(x_i)}|d_t\varepsilon+|\texttt{in}\brangle{1}-\texttt{in}\brangle{2}+\gamma_t'|d_t'\varepsilon$, i.e. for no ``additional'' cost.     
    
    \textbf{Case 2: } For all $i\neq j$, construct the lifting $z_i\brangle{2}(=)^{\#0}z_j\brangle{2}$, which is equivalent to the lifting $\texttt{insample}^{(x_i)}\brangle{2}(=)^{\#}\texttt{insample}^{(x_j)}\brangle{2}$. In particular, this guarantees that all $\texttt{insample}^{(x_i)}\brangle{2}$ are equal to each other. 
    Additionally, for all $i\neq j$, construct the lifting $\zeta_i\brangle{2}(=)^{\#0}\zeta_j\brangle{2}$, which is equivalent to the lifting $X_i\brangle{2} - X_j\brangle{2} (=)^{\#0}\mu_i\brangle{2}-\mu_j\brangle{2}$.z

    As before, if case two is satisfied, then these liftings suffice to show that the proposition  ``$c$ is satisfied in run $\brangle{2}$'' must always be true; thus, the implication ``$c$ is satisfied in run $\brangle{1}\implies c$ is satisfied in run $\brangle{2}$'' must also always be true, and so $\PP[\vec{X}\brangle{1}, t, \texttt{in}\brangle{1}, \sigma]\leq e^{d\varepsilon}\PP[\vec{X}\brangle{2}, t, \texttt{in}\brangle{2}, \sigma]$ for 
    $d = |\mu_i\brangle{1}-\mu_i\brangle{2}+\gamma_{x_i}|d_x\varepsilon + |\texttt{in}\brangle{1}-\texttt{in}\brangle{2}+\gamma_t^{(x_i)}|d_t\varepsilon+|\texttt{in}\brangle{1}-\texttt{in}\brangle{2}+\gamma_t'|d_t'\varepsilon$.

\end{proof}


\begin{proof}[Proof of \ref{2vUnsatisfiableImpliesNotWellformedLemma}]
    Suppose that we have some maximally satisfied coupling strategy $C$ for $L$. There must be some constraint that is violated by $C$.

    By lemma \ref{ProgramCounterexampleThm}, there must be either a leaking cycle, leaking pair, disclosing cycle, or privacy violating path with respect to a single variable. 

    We show that, if there only exist leaking pairs in $L$, then at least one leaking pair must be a non-cancelling leaking pair. In every other case, there exists a problematic graph structure and the proof is complete. 

    For the sake of contradiction, suppose that every leaking pair $\kappa, \kappa'$ in $L$ is a cancelling leaking pair. By definition, this means that for every two transitions $t_i, t_j$ in $\kappa, \kappa'$, $at_x(i) = at_x(j)$ and $at_y(i) = at_y(j)$. 

    Without loss of generality, we will assume that every non-$\texttt{true}$ transition in $\kappa$ must either have guard $\mvlguard[\texttt{x}]\land\mvgguard[\texttt{y}]$ or $\mvlguard[\texttt{x}]\lor\mvgguard[\texttt{y}]$. Thus, every non-$\texttt{true}$ transition in $\kappa'$ must either have guard $\mvgguard[\texttt{x}]\land\mvlguard[\texttt{y}]$ or $\mvgguard[\texttt{x}]\lor\mvlguard[\texttt{y}]$, respectively. 

    Let $t_i$ be an arbitrary non-$\texttt{true}$ transition in $\kappa$ and $t_j$ be an arbitrary non-$\texttt{true}$ transition in $\kappa'$.

    Consider the case where $c_i = \mvlguard[\texttt{x}]\land\mvgguard[\texttt{y}]$ and $c_j = \mvgguard[\texttt{x}]\land\mvlguard[\texttt{y}]$; the other case is symmetric.

    Observe that at least one of $\texttt{in}_{at_x(i)}\brangle{1}\leq \texttt{in}_{at_y(i)}\brangle{1}$ or $\texttt{in}_{at_y(i)}\brangle{1}\geq \texttt{in}_{at_y(i)}\brangle{1}$ must be true.
    
    Suppose that $\texttt{in}_{at_x(i)}\brangle{1}\leq \texttt{in}_{at_y(i)}\brangle{1}$. The case where $\texttt{in}_{at_y(i)}\brangle{1}\geq \texttt{in}_{at_y(i)}\brangle{1}$ is symmetric. 
    Then we can set $\gamma_{at_x(i)}^{(x)} = -1$ and $\gamma_{at_y(i)}^{(y)}=1$; since $\texttt{in}_{at_x(i)}\brangle{1}\leq \texttt{in}_{at_y(i)}\brangle{1}$, $c_i\brangle{1}$ is a contradiction, fulfilling condition (1) of lemma \ref{mvCrossCoupling}. 

    Further, we can assign $\gamma_j^{(x)} = \gamma_j^{(y)}=\texttt{in}\brangle{2}-\texttt{in}\brangle{1}$ freely; thus, we have shown that, with regards to leaking pairs, no constraints of the privacy constraint system can be violated.    
    
    In particular, because there do not exist disclosing cycles, leaking cycles, or privacy violating paths in either variable, this cannot violate any further constraints. Thus, $C$ is not maximal, which is our contradiction, so $L$ must contain either a leaking cycle, disclosing cycle, privacy violating path, or non-cancelling leaking pair in at least one variable.
\end{proof}

