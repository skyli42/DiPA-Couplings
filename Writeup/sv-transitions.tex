
\subsection{Individual Transitions}

Transitions act as guarded statements whose guard is dependent on a persistent real-valued variable $\texttt{x}$ and a real-valued input to which random noise is added; we can thus formally define individual transitions as follows:

\begin{defn}[Transitions]\label{svTransDef}
    A transition is a tuple $t = (c, \sigma, \tau)$, where \begin{itemize}
        \item $c\in \{\texttt{true}, \lguard[\texttt{x}], \gguard[\texttt{x}]\}$ is a \textbf{guard} for the transition.
        \item $\sigma \in \Gamma\cup\{\texttt{insample}, \texttt{insample}'\}$ is the \textbf{output} of $t$, for some finite alphabet of symbols $\Gamma$.
        \item $\tau\in\{\texttt{true}, \texttt{false}\}$ is an \textbf{assignment control}: a boolean value indicating whether or not the stored value of $\texttt{x}$ will be updated when $t$ is taken.
    \end{itemize}
\end{defn}

We additionally associate two positive real-valued \textbf{noise parameters} $P(t) = (d, d')$ with each transition. 

Furthermore, we introduce a special type of transition called a \textbf{public} transition, which we use to represent reading publicly-available data. Every \textbf{public} transition must be of the form $t_{pub}= (\texttt{true}, \sigma, \tau)$ for some $\sigma \in \Gamma\cup\{\texttt{insample}, \texttt{insample}'\}$ and $\tau \in \{\texttt{true}, \texttt{false}\}$. We will call all other transitions \textbf{private}. 

\subsubsection{Transition Semantics}

We can think of each transition as defining an atomic program step: a transition reads a real valued input $\texttt{in}$, compares it to a threshold $\texttt{x}$, and, depending on the result of the comparison, outputs a value $\sigma$ and possibly updates the value of $\texttt{x}$.

The semantics of a transition are given by a function that maps an initial program state and a real-valued input to a subsequent program state. 

A program state is a tuple consisting of a distribution of possible values for the program value $\texttt{x}$, and a distribution of possible values for the current output $\sigma$. 

Let $S = dist(\RR\times (\Gamma \cup \RR)^*)$ be the set of all possible distributions over program states. 
As expected, every possible input is simply an element of $\RR$.

Then the semantics of a transition $t$ can be defined as a function $\Phi_t:dist_\downarrow(S)\times \RR \to dist_\downarrow (S)$ that maps a subdistribution of initial program states and an input to a subdistribution of subsequent program states. 

More precisely, given $t = (c, \sigma, \tau)$ where $t$ has noise parameters $P(t) = (d_t, d_t')$, let $\texttt{insample}$ be the Laplace distribution $\Lap(\texttt{in}, \frac{1}{d_t\varepsilon})$, and $\texttt{insample}'$ be the independent Laplace distribution $\Lap(\texttt{in}, \frac{1}{d_t'\varepsilon})$. Let $\theta$ be a subdistribution of program states. 

Then $\Phi_t(\theta, \texttt{in})$ is a subdistribution $O$ such that for all states $(\texttt{x}, \sigma_0)$, \begin{align*}
   \PP_O[(\texttt{x}, \sigma_0\cdot \sigma)]&= \begin{cases}
    \PP_\theta[(\texttt{x}, \sigma_0)]\PP[c \text{ is satisfied for }\texttt{insample}\text{ and }\texttt{x}]& \tau = \texttt{false}\\
    0 & \tau = \texttt{true}
  \end{cases} \\
  \PP_O[(\texttt{insample}, \sigma_0\cdot \sigma)]&= \begin{cases}
    \PP_\theta[(\texttt{x}, \sigma_0)]\PP[c \text{ is satisfied for }\texttt{insample}\text{ and }\texttt{x}]& \tau = \texttt{true}\\
    0 & \tau = \texttt{false}
  \end{cases} 
\end{align*}

Every other possible state is assigned probability 0 by $O$; with probability $1-\sum_{s\in S} \PP_O[s]$, we consider the transition to have halted.

We primarily are concerned with the probability that a transition outputs a value (i.e. its guard is satisfied) and, in particular, outputs a certain value $o$, where $o\subseteq (\Gamma\cup\RR)^*$ is a measurable event.

We denote this probability as $\PP[\texttt{x}, t, \texttt{in}, o]$, where $\texttt{x} \in dist(\RR)$ is the initial distribution of $\texttt{x}$, $t$ is a transition, $\texttt{in}\in \RR$ is a real-valued input, and $o\in \Gamma\cup \mathcal{P}(\RR)$ is a possible output of $t$. 
Specifically, let $O = \Phi_t((\texttt{x}, \lambda), \texttt{in})$, where $\texttt{x}$ is a distribution over real numbers and $\lambda$ represents the distribution that assigns probability 1 to the empty string, be a subdistribution.
 We abuse notation by using $(\texttt{x}, \lambda)$ to represent, depending on context, a tuple of distributions, the joint distribution of $\texttt{x}$ and $\lambda$, or the subdistribution that assigns probability 1 to the state $(\texttt{x}, \lambda)$. Then $\PP[\texttt{x}, t, \texttt{in}, o]$ is the marginal of $\Phi_t((\texttt{x}, \lambda), \texttt{in})$ on $(\cdot, o)$. \sky{come back to this phrasing}

\subsubsection{Couplings}

We now construct couplings for transitions with the aim of using them as building blocks for proofs of privacy.

First, we need to adapt standard privacy definitions to our specific setting; for example, recall that $\texttt{in}$, in reality, represents a \textbf{function} of some underlying dataset. This means that `closeness' in this context is defined as follows:

\begin{defn}[Adjacency and Validity]
    Two real-valued inputs $\texttt{in}\sim_{\Delta} \texttt{in}'$ are $\Delta$-adjacent if $|\texttt{in}-\texttt{in}'|\leq \Delta$. For a private transition $t$, $\texttt{in}\sim_{\Delta}\texttt{in}'$ is a \textbf{valid} pair of adjacent inputs if $\Delta = 1$ and for a public transition, $\texttt{in}\sim_{\Delta}\texttt{in}'$ is valid if $\Delta = 0$.
\end{defn}

Note that, in order to properly model public transitions (i.e. transitions whose input is public information), we require that all adjacent runs of the program provide the exact same input to a public transition. 

We show that, for any transition, we can construct approximate liftings such that each transition is proven ``private''. 

In particular, we construct liftings that are \textbf{parameterized} by three real values, $\gamma_x$, $\gamma_q$, and $\gamma_q'$. Specifically, we view choices of $\gamma_x, \gamma_q$, and $\gamma_q'$ as a \textbf{strategy} for proving that a transition is differentially private. 

\begin{defn}[Valid Coupling Strategies]
    A \textbf{valid coupling strategy} for a transition $t = (c, \sigma, \tau)$ is a tuple $C_t = (\gamma_x, \gamma_t, \gamma_t')\in [-1, 1]^3$ such that the constraints \[
        \begin{cases}
          \gamma_t\leq\gamma_x & c = \lguard[\texttt{x}]\\
          \gamma_t\geq\gamma_x & c = \gguard[\texttt{x}]\\
          \gamma_t=0 & \sigma = \texttt{insample}\\
          \gamma_t'=0 & \sigma = \texttt{insample}'
        \end{cases},
      \]
      are all satisfied. 
\end{defn}

For any \textbf{valid} coupling strategy (i.e. any collection of shifts that satisfies the given constraints), we can bound the difference of any transition outputting a specific value for any two valid adjacent inputs. 

To construct approximate liftings of a transition $t = (c, \sigma, \tau)$, we will analyze the behaviour of two different \textbf{runs} of $t$, one with input $\texttt{in}\brangle{1}$ and one with input $\texttt{in}\brangle{2}$. 

Our approach to couplings will be that for every Laplace-distributed variable, we will couple the value of the variable in one run with its value in the other \textbf{shifted} by some amount. 

We differentiate between the values of variables in the first and second run by using angle brackets $\brangle{k}$, so, for example, we will take $X\brangle{1}$ to be the value of $\texttt{x}$ at location $q$ in the run of $t$ with input $\texttt{in}\brangle{1}$ and $X\brangle{2}$ to be the value of $\texttt{x}$ in the run of $t$ with input $\texttt{in}\brangle{2}$. 

We thus want to create the lifting $o\brangle{1}\{(a, b): a=\sigma\implies b=\sigma\}o\brangle{2}$, where $o\brangle{1}$ and $o\brangle{2}$ are random variables representing the possible outputs of $t\brangle{1}$ and $t\brangle{2}$, respectively.

We must guarantee two things: that if the first transition's guard is satisfied, then the second transition's guard is also satisfied and that both runs output the same value $\sigma$ when the guard is satisfied. Note that if $c = \texttt{true}$, the first condition is trivially satisfied and when $\sigma\in \Gamma$, the second condition is trivially satisfied. 

This gives us our major coupling lemma, which allows us to define a coupling proof for every valid coupling strategy.

\begin{lemma}\label{simplifiedIndTransitionCoupling}
  For any transition $t$, any possible output event $\sigma$ of $t$ and any two valid adjacent inputs $\texttt{in}\brangle{1}\sim \texttt{in}\brangle{2}$, if we are given a valid coupling strategy, i.e. three real valued ``shifts'' $\gamma_x, \gamma_t, \gamma_t'\in [-1, 1]$ such that \[
    \begin{cases}
      \gamma_t\leq\gamma_x & c = \lguard[\texttt{x}]\\
      \gamma_t\geq\gamma_x & c = \gguard[\texttt{x}]\\
      \gamma_t=0 & \sigma = \texttt{insample}\\
      \gamma_t'=0 & \sigma = \texttt{insample}'
    \end{cases},
  \]
  then we can construct an approximate lifting that proves $\PP[X\brangle{1}, t, \texttt{in}\brangle{1}, \sigma]\leq e^{d\varepsilon}\PP[X\brangle{2}, t, \texttt{in}\brangle{2}, \sigma]$ for some bounded $d>0$ and initial threshold Laplace-distributed variables $X\brangle{1}$, $X\brangle{2}$.
\end{lemma}

A precise version of this lemma can be found in the appendix. 


